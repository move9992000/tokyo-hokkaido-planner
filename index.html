<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Japan Winter Trip 2025</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            background-color: #dcebf6;
            color: #334155;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
        }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .app-container {
            max-width: 480px;
            margin: 0 auto;
            min-height: 100vh;
            background-color: #f8fafc;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
            padding-bottom: 80px;
            overflow-x: hidden;
        }

        .curved-content {
            border-radius: 2rem 2rem 0 0;
            margin-top: -30px;
            position: relative;
            z-index: 10;
            background-color: #f8fafc;
            padding-top: 1.5rem;
            min-height: 500px;
        }

        /* --- ICON 位置調整 --- */
        .nav-tabs {
            position: absolute;
            /* 修改這裡：從 13px 改為 11.5px (再往下移 1.5px) */
            bottom: 11.5px;
            right: 15px;
            display: flex;
            gap: 10px;
            z-index: 20;
        }
        .nav-tab-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .nav-tab-btn.active {
            background: #ffffff;
            color: #3B82F6;
            border-color: #ffffff;
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            opacity: 1;
        }

        /*Canvas for Snow Effect*/
        #snow-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* 確保不擋住點擊 */
            z-index: 5;
        }

        /* 其他樣式 */
        .timeline-line {
            position: absolute;
            left: 19px;
            top: 45px;
            bottom: -20px;
            width: 2px;
            background-color: #e2e8f0;
            z-index: 0;
        }
        .boarding-pass {
            background: linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%);
            border: 1px solid #cbd5e1;
            position: relative;
            overflow: hidden;
        }
        .boarding-pass::before, .boarding-pass::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 20px;
            height: 20px;
            background-color: #f8fafc;
            border-radius: 50%;
            border: 1px solid #cbd5e1;
            transform: translateY(-50%);
        }
        .boarding-pass::before { left: -11px; border-right-color: transparent; border-top-color: transparent; border-bottom-color: transparent; transform: translateY(-50%) rotate(45deg); }
        .boarding-pass::after { right: -11px; border-left-color: transparent; border-top-color: transparent; border-bottom-color: transparent; transform: translateY(-50%) rotate(-45deg); }
    </style>
</head>
<body>

<div id="app">
    <div class="app-container">
        
        <div class="relative h-[230px] w-full overflow-hidden" ref="bannerRef">
            <img src="banner.jpg" alt="Banner" class="w-full h-full object-cover object-center">
            <div class="absolute inset-0 bg-gradient-to-t from-black/20 via-transparent to-transparent"></div>
            
            <canvas id="snow-canvas"></canvas>

            <div class="nav-tabs">
                <button @click="currentTab = 'schedule'" :class="['nav-tab-btn', currentTab === 'schedule' ? 'active' : '']">
                    <i class="fas fa-map-location-dot"></i>
                </button>
                <button @click="currentTab = 'info'" :class="['nav-tab-btn', currentTab === 'info' ? 'active' : '']">
                    <i class="fas fa-circle-info"></i>
                </button>
                <button @click="currentTab = 'shopping'" :class="['nav-tab-btn', currentTab === 'shopping' ? 'active' : '']">
                    <i class="fas fa-basket-shopping"></i>
                </button>
                <button @click="currentTab = 'expenses'" :class="['nav-tab-btn', currentTab === 'expenses' ? 'active' : '']">
                    <i class="fas fa-yen-sign"></i>
                </button>
            </div>
        </div>

        <div class="curved-content px-5">

            <div v-show="currentTab === 'schedule'">
                <div v-if="weather" class="mb-4 bg-blue-50/80 rounded-xl p-3 flex items-center justify-between border border-blue-100 shadow-sm">
                    <div class="flex items-center gap-3">
                        <i :class="getWeatherIcon(weather.code)" class="text-3xl text-blue-500"></i>
                        <div>
                            <div class="text-sm font-bold text-gray-700">{{ schedule[currentDayIndex].location }}</div>
                            <div class="text-xs text-gray-500">{{ weather.desc }}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl font-bold text-gray-800">{{ weather.temp }}°</div>
                        <div class="text-xs text-gray-400">體感 {{ weather.feelsLike }}°</div>
                    </div>
                </div>

                <div class="flex space-x-3 overflow-x-auto hide-scrollbar mb-6 pb-2">
                    <button 
                        v-for="(day, index) in schedule" 
                        :key="index"
                        @click="currentDayIndex = index"
                        class="flex-shrink-0 flex flex-col items-center justify-center w-14 h-16 rounded-xl transition-all border"
                        :class="currentDayIndex === index ? 'bg-blue-600 text-white shadow-lg scale-105 border-blue-600' : 'bg-white text-gray-400 border-gray-100'"
                    >
                        <span class="text-xs uppercase font-bold">{{ getDayName(day.date) }}</span>
                        <span class="text-lg font-bold">{{ getDayNum(day.date) }}</span>
                    </button>
                </div>

                <div id="itinerary-list" class="space-y-0 relative pb-20">
                    <div v-for="(item, idx) in schedule[currentDayIndex].events" :key="item.id" class="relative group itinerary-item pb-6" :data-id="item.id">
                        
                        <div v-if="idx < schedule[currentDayIndex].events.length - 1" class="absolute left-[19px] top-10 bottom-0 w-[2px] bg-gray-200 z-0 flex flex-col items-center justify-center">
                            <div class="bg-gray-100 text-[10px] text-gray-500 px-1 py-0.5 rounded border border-gray-200 mt-4 whitespace-nowrap z-10">
                                <i :class="getTransportIcon(item.transportType)"></i> {{ item.transportTime }}
                            </div>
                        </div>

                        <div v-if="item.category === 'flight' && idx === 0" class="pl-0 mb-4">
                            <div class="boarding-pass rounded-2xl p-4 shadow-sm relative">
                                <div class="flex justify-between items-center mb-3 border-b border-dashed border-gray-300 pb-2">
                                    <div class="text-blue-600 font-bold tracking-widest">FLIGHT</div>
                                    <div class="text-gray-400 text-xs">{{ item.date }}</div>
                                </div>
                                <div class="flex justify-between items-center">
                                    <div class="text-center">
                                        <div class="text-3xl font-bold text-gray-800">{{ item.depCode || 'TPE' }}</div>
                                        <div class="text-xs text-gray-500">{{ item.startTime }}</div>
                                    </div>
                                    <div class="flex-1 flex flex-col items-center px-2">
                                        <i class="fas fa-plane text-gray-300 transform rotate-90"></i>
                                        <div class="text-[10px] text-gray-400 mt-1">{{ item.duration || '飛行中' }}</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-3xl font-bold text-gray-800">{{ item.arrCode || 'CTS' }}</div>
                                        <div class="text-xs text-gray-500">{{ item.endTime }}</div>
                                    </div>
                                </div>
                                <div class="mt-3 text-center text-sm font-medium text-gray-600 bg-gray-50 py-1 rounded">
                                    {{ item.name }}
                                </div>
                            </div>
                        </div>

                        <div v-else class="relative pl-12 cursor-pointer" @click="editEvent(item)">
                            <div class="absolute left-0 top-0 w-10 h-10 rounded-full flex items-center justify-center text-white shadow-md z-10 border-2 border-white"
                                 :class="getCategoryColor(item.category)">
                                <i :class="getCategoryIcon(item.category)"></i>
                            </div>

                            <div class="bg-white rounded-xl p-3 shadow-sm border border-gray-100 hover:shadow-md transition active:scale-95">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-gray-800 text-lg">{{ item.name }}</h3>
                                    <a :href="getMapLink(item.name)" @click.stop target="_blank" class="text-blue-500 bg-blue-50 w-8 h-8 rounded-full flex items-center justify-center">
                                        <i class="fas fa-location-arrow"></i>
                                    </a>
                                </div>
                                
                                <div class="mt-1 flex flex-wrap gap-2 text-xs text-gray-500">
                                    <span v-if="item.startTime" class="bg-gray-100 px-2 py-1 rounded"><i class="far fa-clock mr-1"></i>{{ item.startTime }}~{{item.endTime}}</span>
                                    <span v-if="item.category === 'spot' && item.cost" class="bg-yellow-50 text-yellow-600 px-2 py-1 rounded"><i class="fas fa-ticket-alt mr-1"></i>{{ item.cost }}</span>
                                </div>

                                <p v-if="item.notes" class="mt-2 text-sm text-gray-500 border-l-2 border-gray-200 pl-2 line-clamp-2">
                                    {{ item.notes }}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <button @click="openAddModal('schedule')" class="fixed bottom-6 right-6 w-14 h-14 bg-blue-600 text-white rounded-full shadow-xl flex items-center justify-center text-2xl z-40 hover:scale-110 transition">
                    <i class="fas fa-plus"></i>
                </button>
            </div>

            <div v-show="currentTab === 'info'" class="space-y-6 pb-20">
                
                <div class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100">
                    <h3 class="font-bold text-gray-800 mb-3"><i class="fas fa-coins text-yellow-500 mr-2"></i>匯率換算 (JPY → TWD)</h3>
                    <div class="flex items-center gap-3">
                        <div class="flex-1">
                            <label class="text-xs text-gray-400 block mb-1">日幣 (JPY)</label>
                            <input type="number" v-model="converter.jpy" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-lg font-bold" placeholder="0">
                        </div>
                        <i class="fas fa-arrow-right text-gray-300 mt-4"></i>
                        <div class="flex-1">
                            <label class="text-xs text-gray-400 block mb-1">台幣 (TWD)</label>
                            <div class="w-full bg-blue-50 border border-blue-100 text-blue-800 rounded-lg px-3 py-2 text-lg font-bold">
                                {{ (converter.jpy * settings.rate).toFixed(0) }}
                            </div>
                        </div>
                    </div>
                    <p class="text-[10px] text-gray-400 mt-2 text-right">以匯率 0.22 概算</p>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="bg-blue-600 px-4 py-2 text-white text-sm font-bold flex justify-between items-center">
                        <span><i class="fas fa-plane mr-2"></i>航班資訊</span>
                    </div>
                    <div class="p-4 border-b border-gray-100">
                        <div class="flex justify-between mb-2">
                            <span class="text-xs bg-blue-100 text-blue-600 px-2 py-0.5 rounded font-bold">去程</span>
                            <span class="text-xs text-gray-500">2025/12/24</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <div class="text-center">
                                <div class="text-2xl font-black text-gray-800">TPE</div>
                                <div class="text-xs text-gray-500">08:00</div>
                            </div>
                            <div class="flex-1 flex flex-col items-center px-2">
                                <div class="text-xs text-gray-400 mb-1">BR116</div>
                                <div class="w-full h-[1px] bg-gray-300 relative">
                                    <i class="fas fa-plane absolute top-1/2 left-1/2 transform -translate-y-1/2 -translate-x-1/2 text-gray-400 text-xs"></i>
                                </div>
                                <div class="text-[10px] text-gray-400 mt-1">3h 35m</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-black text-gray-800">CTS</div>
                                <div class="text-xs text-gray-500">12:35</div>
                            </div>
                        </div>
                    </div>
                    <div class="p-4">
                        <div class="flex justify-between mb-2">
                            <span class="text-xs bg-green-100 text-green-600 px-2 py-0.5 rounded font-bold">回程</span>
                            <span class="text-xs text-gray-500">2026/01/04</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <div class="text-center">
                                <div class="text-2xl font-black text-gray-800">NRT</div>
                                <div class="text-xs text-gray-500">14:00</div>
                            </div>
                            <div class="flex-1 flex flex-col items-center px-2">
                                <div class="text-xs text-gray-400 mb-1">JX801</div>
                                <div class="w-full h-[1px] bg-gray-300 relative">
                                    <i class="fas fa-plane absolute top-1/2 left-1/2 transform -translate-y-1/2 -translate-x-1/2 text-gray-400 text-xs rotate-180"></i>
                                </div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-black text-gray-800">TPE</div>
                                <div class="text-xs text-gray-500">17:15</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 gap-3">
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <div class="w-8 h-8 bg-indigo-100 text-indigo-600 rounded-lg flex items-center justify-center mb-2"><i class="fas fa-bed"></i></div>
                        <h4 class="font-bold text-gray-700">札幌王子飯店</h4>
                        <p class="text-xs text-gray-400 mt-1">+81-11-241-1111</p>
                        <a href="usercontent.com/maps.google.com/2" target="_blank" class="text-[10px] text-blue-500 mt-2 block">導航 ></a>
                    </div>
                </div>
            </div>

            <div v-show="currentTab === 'shopping'" class="pb-20">
                <h3 class="font-bold text-xl text-gray-800 mb-4">購物清單 <span class="text-sm font-normal text-gray-400">({{ shoppingList.length }})</span></h3>
                
                <div class="grid grid-cols-2 gap-3">
                    <div v-for="(item, idx) in shoppingList" :key="idx" class="bg-white rounded-xl overflow-hidden shadow-sm border border-gray-100 relative group">
                        <button @click="deleteShoppingItem(idx)" class="absolute top-2 right-2 bg-red-500 text-white w-6 h-6 rounded-full text-xs flex items-center justify-center opacity-0 group-hover:opacity-100 transition z-10"><i class="fas fa-times"></i></button>
                        <div class="h-32 bg-gray-100 relative">
                            <img v-if="item.image" :src="item.image" class="w-full h-full object-cover">
                            <div v-else class="absolute inset-0 flex items-center justify-center text-gray-300"><i class="fas fa-image text-2xl"></i></div>
                        </div>
                        <div class="p-3">
                            <div class="font-bold text-gray-700 truncate">{{ item.name }}</div>
                            <div class="flex items-center gap-1 text-xs text-gray-400 mt-1">
                                <input type="checkbox" v-model="item.checked" class="rounded text-blue-500">
                                <span>已購買</span>
                            </div>
                        </div>
                    </div>
                </div>
                <button @click="openAddModal('shopping')" class="fixed bottom-6 right-6 w-14 h-14 bg-pink-500 text-white rounded-full shadow-xl flex items-center justify-center text-2xl z-40 hover:scale-110 transition">
                    <i class="fas fa-plus"></i>
                </button>
            </div>

            <div v-show="currentTab === 'expenses'" class="pb-20">
                <div class="bg-gradient-to-r from-slate-700 to-slate-800 rounded-2xl p-5 text-white shadow-lg mb-6">
                    <div class="text-sm opacity-70">總花費 (JPY)</div>
                    <div class="text-3xl font-bold mt-1">¥ {{ totalExpenses.toLocaleString() }}</div>
                    <div class="text-xs opacity-60 mt-1">約 TWD {{ (totalExpenses * 0.22).toFixed(0).toLocaleString() }}</div>
                </div>

                <div class="space-y-3">
                    <div v-for="(expense, idx) in expenses" :key="idx" class="bg-white rounded-xl p-3 flex items-center justify-between shadow-sm border border-gray-100">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center text-white text-sm"
                                 :class="getCategoryColor(expense.category)">
                                <i :class="getCategoryIcon(expense.category)"></i>
                            </div>
                            <div>
                                <div class="font-bold text-gray-800">{{ expense.name }}</div>
                                <div class="text-xs text-gray-400">{{ expense.date }} • {{ expense.payment }}</div>
                            </div>
                        </div>
                        <div class="font-bold text-gray-700">¥{{ expense.amount }}</div>
                    </div>
                </div>
                <button @click="openAddModal('expense')" class="fixed bottom-6 right-6 w-14 h-14 bg-yellow-500 text-white rounded-full shadow-xl flex items-center justify-center text-2xl z-40 hover:scale-110 transition">
                    <i class="fas fa-plus"></i>
                </button>
            </div>

        </div>

        <div v-if="showModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-fade-in">
            <div class="bg-white w-full max-w-sm rounded-2xl p-5 shadow-2xl transform transition-all scale-100">
                <h3 class="text-lg font-bold mb-4">{{ modalTitle }}</h3>
                
                <div v-if="modalType === 'schedule'" class="space-y-3">
                    <select v-model="editForm.category" class="w-full p-2 border rounded-lg bg-gray-50">
                        <option value="spot">景點</option>
                        <option value="food">美食</option>
                        <option value="shop">購物</option>
                        <option value="hotel">住宿</option>
                        <option value="flight">航班</option>
                    </select>
                    <input v-model="editForm.name" placeholder="名稱" class="w-full p-2 border rounded-lg">
                    <div class="flex gap-2">
                        <input v-model="editForm.startTime" type="time" class="w-1/2 p-2 border rounded-lg">
                        <input v-model="editForm.endTime" type="time" class="w-1/2 p-2 border rounded-lg">
                    </div>
                    <input v-if="editForm.category === 'spot'" v-model="editForm.cost" placeholder="門票價格" class="w-full p-2 border rounded-lg">
                    
                    <div class="bg-gray-50 p-2 rounded-lg">
                        <label class="text-xs text-gray-500">前往下一站的交通</label>
                        <div class="flex gap-2 mt-1">
                            <select v-model="editForm.transportType" class="p-1 text-sm border rounded">
                                <option value="walk">步行</option>
                                <option value="train">大眾運輸</option>
                            </select>
                            <input v-model="editForm.transportTime" placeholder="例如: 15分" class="flex-1 p-1 text-sm border rounded">
                        </div>
                    </div>

                    <textarea v-model="editForm.notes" placeholder="備註" class="w-full p-2 border rounded-lg h-20"></textarea>
                </div>

                <div v-if="modalType === 'shopping'" class="space-y-3">
                    <input v-model="shoppingForm.name" placeholder="商品名稱" class="w-full p-2 border rounded-lg">
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:bg-gray-50 relative">
                        <input type="file" @change="handleImageUpload" class="absolute inset-0 opacity-0 cursor-pointer">
                        <span class="text-gray-400 text-sm"><i class="fas fa-camera mr-1"></i> 上傳圖片</span>
                    </div>
                </div>

                <div v-if="modalType === 'expense'" class="space-y-3">
                    <select v-model="expenseForm.category" class="w-full p-2 border rounded-lg bg-gray-50">
                        <option value="food">飲食</option>
                        <option value="transport">交通</option>
                        <option value="shop">購物</option>
                        <option value="ticket">門票</option>
                        <option value="hotel">住宿</option>
                        <option value="other">其他</option>
                    </select>
                    <input v-model="expenseForm.name" placeholder="項目名稱" class="w-full p-2 border rounded-lg">
                    <input v-model="expenseForm.amount" type="number" placeholder="金額 (日幣)" class="w-full p-2 border rounded-lg">
                    <select v-model="expenseForm.payment" class="w-full p-2 border rounded-lg">
                        <option value="現金">現金</option>
                        <option value="信用卡">信用卡</option>
                        <option value="Suica/IC">西瓜卡</option>
                    </select>
                </div>

                <div class="flex gap-3 mt-6">
                    <button v-if="isEditing" @click="confirmDelete" class="flex-1 bg-red-100 text-red-500 py-2 rounded-lg font-bold">刪除</button>
                    <button @click="showModal = false" class="flex-1 bg-gray-100 text-gray-500 py-2 rounded-lg font-bold">取消</button>
                    <button @click="saveData" class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-bold">儲存</button>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    const { createApp, ref, computed, onMounted, watch, onUnmounted } = Vue;

    createApp({
        setup() {
            const currentTab = ref('schedule');
            const currentDayIndex = ref(0);
            const showModal = ref(false);
            const modalType = ref(''); // schedule, shopping, expense
            const isEditing = ref(false);
            const converter = ref({ jpy: 1000 });
            const weather = ref(null);
            const bannerRef = ref(null);

            // 全域設定
            const settings = ref({ rate: 0.225 }); // 預設匯率
            const members = ref(['我']); // 預設成員
            
            // 資料 Refs
            const schedule = ref([
                { date: "2025-12-24", location: "Tokyo", events: [{ id: 1, category: 'flight', name: '前往東京', startTime: '08:00', endTime: '12:35', depCode: 'TPE', arrCode: 'CTS', transportType: 'train', transportTime: '45分' }, { id: 2, category: 'hotel', name: '東京王子飯店', startTime: '15:00', endTime: '', notes: 'Check-in', transportType: 'walk', transportTime: '10分' }, { id: 3, category: 'spot', name: '六本木聖誕燈飾', startTime: '18:00', endTime: '20:00', cost: '免費', notes: '櫸坂通點燈', transportType: 'walk', transportTime: '-' }] },
                { date: "2025-12-25", location: "Tokyo", events: [{ id: 10, category: 'spot', name: '迪士尼樂園', startTime: '09:00', endTime: '21:00', cost: '¥9400', notes: '聖誕遊行必看', transportType: 'train', transportTime: '30分' }] },
                { date: "2025-12-26", location: "Tokyo", events: [] }, { date: "2025-12-27", location: "Sapporo", events: [] }, { date: "2025-12-28", location: "Sapporo", events: [] }
            ]);
            const shoppingList = ref([]);
            const expenses = ref([]);

            // Forms
            const editForm = ref({});
            const shoppingForm = ref({});
            const expenseForm = ref({});

            // ---------------- 動態積雪 Canvas 邏輯 ----------------
            let canvas, ctx, animationId;
            const flakes = [];
            const snowPileHeight = new Array(480).fill(0); // 模擬螢幕寬度，記錄每點積雪高度

            // 初始化 Canvas
            const initCanvas = () => {
                canvas = document.getElementById('snow-canvas');
                if (!canvas) return;
                
                const resize = () => {
                    canvas.width = canvas.parentElement.offsetWidth;
                    canvas.height = canvas.parentElement.offsetHeight;
                    // 重置積雪陣列
                    if (snowPileHeight.length !== canvas.width) {
                       snowPileHeight.length = canvas.width;
                       for(let i=0; i<canvas.width; i++) snowPileHeight[i] = 0;
                    }
                };
                window.addEventListener('resize', resize);
                resize();

                // 產生雪花
                for (let i = 0; i < 60; i++) {
                    flakes.push({
                        x: Math.random() * canvas.width,
                        y: Math.random() * canvas.height,
                        r: Math.random() * 2 + 1,
                        d: Math.random() * 1 + 0.5 // 密度/速度
                    });
                }
                
                animateSnow();
            };

            const animateSnow = () => {
                if (!canvas) return;
                ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // 1. 繪製積雪
                ctx.fillStyle = "rgba(255, 255, 255, 0.9)";
                ctx.beginPath();
                ctx.moveTo(0, canvas.height);
                for (let i = 0; i < canvas.width; i++) {
                    // 讓積雪稍微平滑一點，不要太鋸齒
                    let h = snowPileHeight[i];
                    ctx.lineTo(i, canvas.height - h);
                }
                ctx.lineTo(canvas.width, canvas.height);
                ctx.fill();

                // 2. 繪製與更新雪花
                ctx.fillStyle = "rgba(255, 255, 255, 0.8)";
                ctx.beginPath();
                for (let i = 0; i < flakes.length; i++) {
                    const f = flakes[i];
                    ctx.moveTo(f.x, f.y);
                    ctx.arc(f.x, f.y, f.r, 0, Math.PI * 2, true);
                }
                ctx.fill();
                updateFlakes();
                
                animationId = requestAnimationFrame(animateSnow);
            };

            const updateFlakes = () => {
                for (let i = 0; i < flakes.length; i++) {
                    const f = flakes[i];
                    f.y += Math.pow(f.d, 2) + 1; // 下落速度
                    f.x += Math.sin(f.y * 0.05) * 0.5; // 左右飄動

                    // 碰到積雪或底部
                    const floorIndex = Math.floor(f.x);
                    // 邊界檢查
                    if (floorIndex >= 0 && floorIndex < canvas.width) {
                        const pileHeight = snowPileHeight[floorIndex];
                        // 如果碰到積雪 (高度 = canvas.height - pileHeight)
                        if (f.y + f.r >= canvas.height - pileHeight) {
                            // 堆積：增加該點高度 (有上限，例如 35px，避免擋太多)
                            if (pileHeight < 35) {
                                // 增加一點範圍的積雪，讓它比較像小山丘
                                for(let k = -2; k <= 2; k++) {
                                    if (floorIndex + k >= 0 && floorIndex + k < canvas.width) {
                                        snowPileHeight[floorIndex + k] += 0.5 * (3 - Math.abs(k)); // 中間加多，旁邊加少
                                    }
                                }
                            }
                            // 重置雪花到頂部
                            resetFlake(f);
                        }
                    } else if (f.y > canvas.height) {
                        resetFlake(f);
                    }
                }
            };

            const resetFlake = (f) => {
                f.y = -10;
                f.x = Math.random() * canvas.width;
            };
            // --------------------------------------------------------

            onMounted(() => {
                const savedData = localStorage.getItem('tripData');
                if (savedData) {
                    const parsed = JSON.parse(savedData);
                    schedule.value = parsed.schedule || schedule.value;
                    shoppingList.value = parsed.shoppingList || [];
                    expenses.value = parsed.expenses || [];
                    members.value = parsed.members || ['我'];
                    settings.value = parsed.settings || { rate: 0.225 };
                }
                initSortable();
                fetchWeather();
                
                // 啟動 Canvas
                setTimeout(initCanvas, 100);
            });

            onUnmounted(() => {
                cancelAnimationFrame(animationId);
            });

            watch([schedule, shoppingList, expenses, members, settings], () => {
                localStorage.setItem('tripData', JSON.stringify({
                    schedule: schedule.value,
                    shoppingList: shoppingList.value,
                    expenses: expenses.value,
                    members: members.value,
                    settings: settings.value
                }));
            }, { deep: true });

            // ... (其他既有 Functions 保持不變) ...
            
            const initSortable = () => {
                const el = document.getElementById('itinerary-list');
                if(el) {
                    new Sortable(el, { animation: 150, handle: '.itinerary-item', onEnd: function (evt) { const item = schedule.value[currentDayIndex.value].events.splice(evt.oldIndex, 1)[0]; schedule.value[currentDayIndex.value].events.splice(evt.newIndex, 0, item); } });
                }
            };
            watch(currentDayIndex, () => { setTimeout(initSortable, 100); fetchWeather(); });
            const fetchWeather = async () => { /* 簡化: 模擬請求 */ weather.value = { temp: -2, feelsLike: -5, code: 71, desc: '降雪' }; };
            
            const getDayName = (d) => new Date(d).toLocaleDateString('en-US', { weekday: 'short' });
            const getDayNum = (d) => new Date(d).getDate();
            const getCategoryIcon = (c) => ({ flight: 'fa-plane', hotel: 'fa-bed', spot: 'fa-camera', food: 'fa-utensils', shop: 'fa-bag-shopping', transport: 'fa-train', ticket: 'fa-ticket', other: 'fa-star' }[c] || 'fa-circle');
            const getCategoryColor = (c) => ({ flight: 'bg-blue-400', hotel: 'bg-indigo-400', spot: 'bg-pink-400', food: 'bg-orange-400', shop: 'bg-yellow-400', transport: 'bg-green-400' }[c] || 'bg-gray-400');
            const getTransportIcon = (t) => t === 'walk' ? 'fas fa-person-walking' : 'fas fa-train-subway';
            const getWeatherIcon = () => 'fas fa-snowflake';
            const getMapLink = (n) => `https://www.google.com/maps/search/?api=1&query=$${encodeURIComponent(n)}`;
            // (注意: getSnowStyle 已移除，因為改用 Canvas)
            
            const totalExpenses = computed(() => expenses.value.reduce((sum, item) => sum + Number(item.amount), 0));
            const modalTitle = computed(() => ({ schedule: isEditing.value?'編輯行程':'新增行程', shopping:'新增購物清單', expense:'新增花費' }[modalType.value] || ''));

            const openAddModal = (type) => {
                modalType.value = type; isEditing.value = false;
                editForm.value = { category: 'spot', transportType: 'train', transportTime: '20分' };
                shoppingForm.value = {};
                expenseForm.value = { category: 'food', payment: '現金', date: schedule.value[currentDayIndex.value].date, payer: '我', involved: [...members.value] };
                showModal.value = true;
            };
            const editEvent = (item) => { if(item.category==='flight')return; modalType.value='schedule'; isEditing.value=true; editForm.value=JSON.parse(JSON.stringify(item)); showModal.value=true; };
            const handleImageUpload = (e) => { const f=e.target.files[0]; if(f){ const r=new FileReader(); r.onload=(e)=>shoppingForm.value.image=e.target.result; r.readAsDataURL(f); } };
            const saveData = () => {
                if(modalType.value==='schedule') { if(isEditing.value){ const idx=schedule.value[currentDayIndex.value].events.findIndex(e=>e.id===editForm.value.id); if(idx!==-1) schedule.value[currentDayIndex.value].events[idx]=editForm.value; } else { editForm.value.id=Date.now(); schedule.value[currentDayIndex.value].events.push(editForm.value); } }
                else if(modalType.value==='shopping') shoppingList.value.push(shoppingForm.value);
                else if(modalType.value==='expense') expenses.value.push(expenseForm.value);
                showModal.value = false;
            };
            const confirmDelete = () => { if(confirm("刪除?")){ const idx=schedule.value[currentDayIndex.value].events.findIndex(e=>e.id===editForm.value.id); if(idx!==-1)schedule.value[currentDayIndex.value].events.splice(idx,1); showModal.value=false; } };
            const deleteShoppingItem = (i) => { if(confirm("刪除?")) shoppingList.value.splice(i,1); };

            return {
                currentTab, currentDayIndex, schedule, showModal, modalType, isEditing, modalTitle,
                editForm, shoppingForm, expenseForm, shoppingList, expenses, converter, weather, settings, members,
                totalExpenses, bannerRef,
                openAddModal, editEvent, saveData, confirmDelete, deleteShoppingItem, handleImageUpload,
                getDayName, getDayNum, getCategoryIcon, getCategoryColor, getTransportIcon, getWeatherIcon, getMapLink
            };
        }
    }).mount('#app');
</script>

</body>
</html>
