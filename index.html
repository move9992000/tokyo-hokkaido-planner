<script>
    const { createApp, ref, computed, onMounted, watch, onUnmounted, nextTick } = Vue;

    createApp({
        setup() {
            // --- æ ¸å¿ƒç‹€æ…‹ ---
            const currentTab = ref('schedule');
            const currentDayIndex = ref(0);
            const showModal = ref(false);
            const modalType = ref(''); // schedule, shopping, expense
            const isEditing = ref(false);
            const isDraggable = ref(false);
            
            // --- è³‡æ–™ç‹€æ…‹ (é è¨­å€¼) ---
            const members = ref(['æˆ‘']);
            const currentChecklistMember = ref('æˆ‘');
            const settings = ref({ rate: 0.225, lastUpdate: '' });
            const converter = ref({ jpy: 1000, twd: 225 });
            const weather = ref(null);
            
            // ç·¨è¼¯ç”¨è¡¨å–®æš«å­˜
            const editForm = ref({});
            const shoppingForm = ref({});
            const expenseForm = ref({});

            // ä½å®¿æ¸…å–®
            const hotels = ref([
                { name: 'Hotel Sunroute Asakusa', dates: '12/24 - 12/27', address: 'æ±äº¬éƒ½å°æ±å€é›·é–€1-8-5', phone: '+81-3-3847-1511', mapLink: 'https://www.google.com/maps/search/?api=1&query=Hotel+Sunroute+Asakusa' },
                { name: 'Hotel Nets Sapporo', dates: '12/27 - 12/31', address: 'åŒ—æµ·é“æœ­å¹Œå¸‚ä¸­å¤®å€å—7æ¡è¥¿4ä¸ç›®1-1', phone: '+81-11-530-5511', mapLink: 'https://www.google.com/maps/search/?api=1&query=Hotel+Nets+Sapporo' },
                { name: 'LA JOLIE MOTOMACHI', dates: '12/31 - 01/02', address: 'åŒ—æµ·é“å‡½é¤¨å¸‚æœ«å»£ç”º6-6', phone: '+81-138-23-3322', mapLink: 'https://www.google.com/maps/search/?api=1&query=LA+JOLIE+MOTOMACHI' },
                { name: 'Sotetsu Fresa Inn Tokyo-Roppongi', dates: '01/02 - 01/04', address: 'æ±äº¬éƒ½æ¸¯å€å…­æœ¬æœ¨3-10-1', phone: '+81-3-5413-2031', mapLink: 'https://www.google.com/maps/search/?api=1&query=Sotetsu+Fresa+Inn+Tokyo-Roppongi' }
            ]);

            // è¡Œç¨‹è³‡æ–™çµæ§‹
            const schedule = ref([
                { date: "2025-12-24", location: "Tokyo", events: [{ id: 1, category: 'flight', name: 'å°åŒ—(TSA) âœˆï¸ æ±äº¬(HND)', startTime: '13:30', endTime: '17:30', depCode: 'TSA', arrCode: 'HND', duration: '3h', transportType: 'train', transportTime: '45åˆ†' }, { id: 2, category: 'hotel', name: 'æ±äº¬ä½å®¿ Check-in', startTime: '19:00', endTime: '', notes: 'ç¬¬ä¸€æ™šæ±äº¬', transportType: 'walk', transportTime: '10åˆ†' }] },
                { date: "2025-12-25", location: "Tokyo", events: [] }, 
                { date: "2025-12-26", location: "Tokyo", events: [] },
                { date: "2025-12-27", location: "Tokyo/Sapporo", events: [{ id: 10, category: 'flight', name: 'æ±äº¬(HND) âœˆï¸ æœ­å¹Œ(CTS)', startTime: '18:00', endTime: '19:35', depCode: 'HND', arrCode: 'CTS', duration: '1h 35m', transportType: 'train', transportTime: '40åˆ†' }, { id: 11, category: 'hotel', name: 'æœ­å¹Œä½å®¿ Check-in', startTime: '21:00', endTime: '', notes: 'æŠµé”åŒ—æµ·é“', transportType: 'walk', transportTime: '-' }] },
                { date: "2025-12-28", location: "Sapporo", events: [] }, 
                { date: "2025-12-29", location: "Sapporo", events: [] }, 
                { date: "2025-12-30", location: "Sapporo", events: [] },
                { date: "2025-12-31", location: "Hakodate", events: [{ id: 20, category: 'transport', name: 'æœ­å¹Œ ðŸš„ å‡½é¤¨ (JRç‰¹æ€¥)', startTime: '10:56', endTime: '14:41', notes: 'ç§»å‹•æ—¥', transportType: 'walk', transportTime: '20åˆ†' }, { id: 21, category: 'hotel', name: 'å‡½é¤¨ä½å®¿', startTime: '15:30', endTime: '', notes: 'è·¨å¹´å¤œ', transportType: 'walk', transportTime: '-' }] },
                { date: "2026-01-01", location: "Hakodate", events: [] },
                { date: "2026-01-02", location: "Tokyo", events: [{ id: 30, category: 'flight', name: 'å‡½é¤¨(HKD) âœˆï¸ æ±äº¬(HND)', startTime: '11:45', endTime: '13:15', depCode: 'HKD', arrCode: 'HND', duration: '1h 30m', transportType: 'train', transportTime: '40åˆ†' }, { id: 31, category: 'hotel', name: 'æ±äº¬ä½å®¿', startTime: '15:00', endTime: '', notes: 'å›žåˆ°æ±äº¬', transportType: 'walk', transportTime: '-' }] },
                { date: "2026-01-03", location: "Tokyo", events: [] },
                { date: "2026-01-04", location: "Tokyo", events: [{ id: 40, category: 'flight', name: 'æ±äº¬(HND) âœˆï¸ å°åŒ—(TSA)', startTime: '12:40', endTime: '15:50', depCode: 'HND', arrCode: 'TSA', duration: '4h 10m', transportType: 'walk', transportTime: '-' }] }
            ]);

            // è³¼ç‰©èˆ‡èŠ±è²»
            const shoppingList = ref([]);
            const expenses = ref([]);

            // è¡ŒæŽæ¸…å–®æ¨¡æ¿èˆ‡è³‡æ–™
            const defaultPackingTemplate = [
                { name: 'é‡è¦æ–‡ä»¶', items: [ {name:'è­·ç…§',tag:'éš¨èº«',important:true}, {name:'ç°½è­‰',tag:'éš¨èº«',important:true}, {name:'åœ‹éš›é§•ç…§'}, {name:'æ©Ÿç¥¨',tag:'éš¨èº«',important:true}, {name:'ä½å®¿æ†‘è­‰'}, {name:'äº¤é€šç¥¨åˆ¸'}, {name:'å¤–å¹£',tag:'éš¨èº«',important:true}, {name:'ä¿¡ç”¨å¡',tag:'éš¨èº«',important:true}, {name:'æ—…éŠæ‰‹å†Š'} ] },
                { name: '3C ç”¢å“', items: [ {name:'æ‰‹æ©Ÿ',tag:'éš¨èº«',important:true}, {name:'å……é›»ç·š'}, {name:'å……é›»å™¨'}, {name:'è¡Œå‹•é›»æº',tag:'éš¨èº«',important:true}, {name:'è¬ç”¨è½‰æŽ¥é ­'}, {name:'ç­†é›»',tag:'éš¨èº«'}, {name:'ç›¸æ©Ÿ'}, {name:'ç¶²å¡'}, {name:'è‡ªæ‹æ£’'} ] },
                { name: 'ç›¥æ´—ç”¨å“', items: [ {name:'å¸å¦æ£‰'}, {name:'æ´—é¢ä¹³',tag:'æ‰˜é‹'}, {name:'ç‰™è†'}, {name:'ç‰™åˆ·'}, {name:'æ¿•ç´™å·¾'}, {name:'é¢ç´™'}, {name:'é˜²æ›¬ç”¨å“',tag:'æ‰˜é‹'}, {name:'ä¿é¤Šå“',tag:'æ‰˜é‹'}, {name:'è­·é«®ç”¨å“'} ] },
                { name: 'å€‹äººè—¥å“', items: [ {name:'çœ¼è—¥æ°´'}, {name:'éŽæ•è—¥'}, {name:'æšˆè»Šè—¥'}, {name:'æ„Ÿå†’è—¥'}, {name:'è…¸èƒƒè—¥'}, {name:'èšŠèŸ²æ­¢ç™¢è—¥'} ] },
                { name: 'å€‹äººè¡£ç‰©', items: [ {name:'æ›æ´—è¡£ç‰©'}, {name:'å¤–å¥—'}, {name:'é´å­'}, {name:'å…§è¡£è¤²'}, {name:'è¥ªå­'}, {name:'å¸½å­'} ] },
                { name: 'å…¶ä»–ç”¨å“', items: [ {name:'è€³å¡ž'}, {name:'å£ç½©'}, {name:'é›¨å‚˜',tag:'æ‰˜é‹'}, {name:'æ‰‹å¥—'}, {name:'è¡›ç”Ÿæ£‰'}, {name:'åŒ–å¦å“'} ] }
            ];
            const getNewPackingList = () => JSON.parse(JSON.stringify(defaultPackingTemplate));
            const packingData = ref({ 'æˆ‘': getNewPackingList() });

            // --- è¨ˆç®—å±¬æ€§ ---
            const currentChecklistData = computed(() => {
                const member = currentChecklistMember.value || 'æˆ‘';
                if (!packingData.value[member]) packingData.value[member] = getNewPackingList();
                return packingData.value[member];
            });

            const packingProgress = computed(() => {
                let total = 0, checked = 0;
                const list = currentChecklistData.value;
                if(list) list.forEach(cat => cat.items.forEach(i => { total++; if(i.checked) checked++; }));
                return total === 0 ? 0 : Math.round((checked / total) * 100);
            });

            const totalExpenses = computed(() => expenses.value.reduce((sum, item) => sum + Number(item.amount), 0));
            
            const modalTitle = computed(() => ({ 
                schedule: isEditing.value ? 'ç·¨è¼¯è¡Œç¨‹' : 'æ–°å¢žè¡Œç¨‹', 
                shopping: 'æ–°å¢žè³¼ç‰©æ¸…å–®', 
                expense: 'æ–°å¢žèŠ±è²»' 
            }[modalType.value] || ''));

            // çµç®—é‚è¼¯
            const showSettlement = ref(false);
            const settlementPlan = computed(() => {
                let balance = {}; 
                members.value.forEach(m => balance[m] = 0);
                expenses.value.forEach(ex => { 
                    const amt = parseFloat(ex.amount); 
                    if(!amt || !ex.involved || ex.involved.length === 0) return; 
                    
                    // ä»˜æ¬¾äºº +
                    balance[ex.payer] = (balance[ex.payer] || 0) + amt; 
                    
                    // åˆ†æ”¤äºº -
                    const share = amt / ex.involved.length; 
                    ex.involved.forEach(p => { balance[p] = (balance[p] || 0) - share; }); 
                });
                
                let d = [], c = []; 
                for(let p in balance){ 
                    if(balance[p] < -1) d.push({name:p, amount:balance[p]}); // æ¬ éŒ¢çš„ (Debtors)
                    else if(balance[p] > 1) c.push({name:p, amount:balance[p]}); // è©²æ”¶éŒ¢çš„ (Creditors)
                } 
                d.sort((a,b) => a.amount - b.amount); 
                c.sort((a,b) => b.amount - a.amount);
                
                let plan = [], i=0, j=0; 
                while(i < d.length && j < c.length){ 
                    let db = d[i], cr = c[j]; 
                    let amt = Math.min(Math.abs(db.amount), cr.amount); 
                    plan.push({from: db.name, to: cr.name, amount: amt}); 
                    db.amount += amt; 
                    cr.amount -= amt; 
                    if(Math.abs(db.amount) < 1) i++; 
                    if(cr.amount < 1) j++; 
                } 
                return plan;
            });

            // --- æ–¹æ³• ---

            // å³æ™‚å„²å­˜ (Watch)
            watch([schedule, shoppingList, expenses, members, settings, packingData], () => {
                localStorage.setItem('tripData', JSON.stringify({
                    schedule: schedule.value, 
                    shoppingList: shoppingList.value, 
                    expenses: expenses.value, 
                    members: members.value, 
                    settings: settings.value, 
                    packingData: packingData.value
                }));
                // é€™è£¡å¯ä»¥åŠ ä¸€å€‹ console.log ç¢ºèªæ˜¯å¦æœ‰åœ¨å­˜
                console.log('Auto-saved to LocalStorage'); 
            }, { deep: true });

            // è®€å–è³‡æ–™
            onMounted(() => {
                try {
                    const savedData = localStorage.getItem('tripData');
                    if (savedData) {
                        const parsed = JSON.parse(savedData);
                        if(parsed.schedule) schedule.value = parsed.schedule;
                        if(parsed.shoppingList) shoppingList.value = parsed.shoppingList;
                        if(parsed.expenses) expenses.value = parsed.expenses;
                        if(parsed.members) members.value = parsed.members;
                        if(parsed.settings) settings.value = parsed.settings;
                        if(parsed.packingData) packingData.value = parsed.packingData;
                        
                        // è³‡æ–™ä¿®å¾©èˆ‡é·ç§»
                        members.value.forEach(m => {
                            if(!packingData.value[m]) packingData.value[m] = getNewPackingList();
                        });
                    }
                } catch (e) { console.error("Data load error", e); }
                
                initSortable();
                fetchWeather();
                fetchExchangeRate();
                setTimeout(initCanvas, 100);
            });

            // æ ¸å¿ƒï¼šæ–°å¢žèˆ‡ç·¨è¼¯å›žå¯«é‚è¼¯
            const saveData = () => {
                if(modalType.value === 'schedule') {
                    // æ·±æ‹·è²è¡¨å–®è³‡æ–™ï¼Œåˆ‡æ–·åƒç…§
                    const eventData = JSON.parse(JSON.stringify(editForm.value));
                    
                    if(isEditing.value) {
                        // ç·¨è¼¯æ¨¡å¼ï¼šæ‰¾åˆ°è©²äº‹ä»¶ä¸¦æ›´æ–°
                        const currentEvents = schedule.value[currentDayIndex.value].events;
                        const idx = currentEvents.findIndex(e => e.id === eventData.id);
                        if(idx !== -1) {
                            currentEvents[idx] = eventData; // Vue 3 æœƒåµæ¸¬åˆ°é™£åˆ—å…ƒç´ è®Šæ›´
                        }
                    } else {
                        // æ–°å¢žæ¨¡å¼
                        eventData.id = Date.now(); // è³¦äºˆæ–° ID
                        schedule.value[currentDayIndex.value].events.push(eventData);
                    }
                } 
                else if(modalType.value === 'shopping') {
                    shoppingList.value.push({...shoppingForm.value});
                } 
                else if(modalType.value === 'expense') {
                    expenses.value.push({...expenseForm.value});
                }
                
                showModal.value = false;
            };

            // Modal æ“ä½œ
            const handleAddClick = () => { 
                if(currentTab.value === 'schedule') openAddModal('schedule'); 
                else if(currentTab.value === 'shopping') openAddModal('shopping'); 
                else if(currentTab.value === 'expenses') openAddModal('expense'); 
            };
            
            const openAddModal = (type) => { 
                modalType.value = type; 
                isEditing.value = false; 
                // åˆå§‹åŒ–è¡¨å–®
                if(type === 'schedule') {
                    editForm.value = { 
                        category: 'spot', 
                        transportType: 'train', 
                        transportTime: '20åˆ†',
                        startTime: '10:00',
                        endTime: '12:00',
                        name: ''
                    };
                } else if(type === 'shopping') {
                    shoppingForm.value = { name: '', checked: false, image: null };
                } else if(type === 'expense') {
                    expenseForm.value = { 
                        category: 'food', 
                        amount: '', 
                        date: schedule.value[currentDayIndex.value].date, 
                        payer: 'æˆ‘', 
                        involved: [...members.value] 
                    };
                }
                showModal.value = true; 
            };

            const editEvent = (item) => { 
                if(isDraggable.value) return; 
                if(item.category === 'flight') return; // èˆªç­æš«ä¸é–‹æ”¾ç·¨è¼¯
                
                modalType.value = 'schedule'; 
                isEditing.value = true; 
                editForm.value = JSON.parse(JSON.stringify(item)); // æ·±æ‹·è²é¿å…ç›´æŽ¥ä¿®æ”¹
                showModal.value = true; 
            };

            const confirmDelete = () => {
                if(!confirm("ç¢ºå®šè¦åˆªé™¤æ­¤é …ç›®å—Žï¼Ÿ")) return;
                
                if(modalType.value === 'schedule') {
                    const idx = schedule.value[currentDayIndex.value].events.findIndex(e => e.id === editForm.value.id);
                    if(idx !== -1) schedule.value[currentDayIndex.value].events.splice(idx, 1);
                }
                showModal.value = false;
            };

            const deleteShoppingItem = (idx) => {
                if(confirm("ç¢ºå®šåˆªé™¤æ­¤å•†å“ï¼Ÿ")) shoppingList.value.splice(idx, 1);
            };

            // åœ–ç‰‡ä¸Šå‚³
            const handleImageUpload = (e) => { 
                const file = e.target.files[0]; 
                if(file) { 
                    const reader = new FileReader(); 
                    reader.onload = (evt) => { shoppingForm.value.image = evt.target.result; }; 
                    reader.readAsDataURL(file); 
                } 
            };

            // åŒ¯çŽ‡èˆ‡å¤©æ°£
            const fetchExchangeRate = async () => {
                try { 
                    const res = await fetch('https://api.exchangerate-api.com/v4/latest/JPY'); 
                    const data = await res.json(); 
                    if(data && data.rates && data.rates.TWD){ 
                        settings.value.rate = data.rates.TWD; 
                        settings.value.lastUpdate = new Date(data.time_last_updated*1000).toLocaleDateString();
                        calculateTWD(); 
                    } 
                } catch(e){ console.error("Exchange rate error", e); }
            };
            const calculateTWD = () => { converter.value.twd = (converter.value.jpy * settings.value.rate).toFixed(0); };
            const calculateJPY = () => { converter.value.jpy = (converter.value.twd / settings.value.rate).toFixed(0); };
            const fetchWeather = async () => { 
                // é€™è£¡æ¨¡æ“¬å¤©æ°£ API å›žå‚³
                weather.value = { temp: -2, feelsLike: -5, code: 71, desc: 'å°é›ª' }; 
            };

            // æˆå“¡ç®¡ç†
            const addMember = () => { const n = prompt("è¼¸å…¥æ–°æˆå“¡åå­—:"); if(n && !members.value.includes(n)) members.value.push(n); };
            const renameMember = (i) => { 
                const oldName = members.value[i];
                const newName = prompt("ä¿®æ”¹åå­—:", oldName); 
                if(newName && newName !== oldName && !members.value.includes(newName)){ 
                    members.value[i] = newName; 
                    // é·ç§» Packing Data
                    if(packingData.value[oldName]) { 
                        packingData.value[newName] = packingData.value[oldName]; 
                        delete packingData.value[oldName]; 
                    } else { packingData.value[newName] = getNewPackingList(); }
                    
                    // é·ç§» Expenses é—œè¯
                    expenses.value.forEach(e => { 
                        if(e.payer === oldName) e.payer = newName; 
                        const invIdx = e.involved.indexOf(oldName);
                        if(invIdx !== -1) e.involved[invIdx] = newName; 
                    }); 
                    
                    if (currentChecklistMember.value === oldName) currentChecklistMember.value = newName; 
                } 
            };
            const removeMember = (i) => { 
                if(members.value[i] === 'æˆ‘') return alert("ä¸èƒ½åˆªé™¤è‡ªå·±ï¼"); 
                if(confirm("ç¢ºå®šåˆªé™¤æˆå“¡ï¼Ÿ(æœƒä¸€ä½µåˆªé™¤å…¶è¡ŒæŽæ¸…å–®)")){ 
                    const nameToRemove = members.value[i]; 
                    members.value.splice(i, 1); 
                    delete packingData.value[nameToRemove]; 
                    if (currentChecklistMember.value === nameToRemove) currentChecklistMember.value = 'æˆ‘'; 
                    // æ¸…ç† Expenses (å¯é¸)
                } 
            };
            const toggleAllInvolved = () => { 
                if(expenseForm.value.involved.length === members.value.length) expenseForm.value.involved = []; 
                else expenseForm.value.involved = [...members.value]; 
            };

            // æ‹–æ›³æŽ’åº
            let sortableInstance = null;
            const toggleDraggable = () => isDraggable.value = !isDraggable.value;
            watch(isDraggable, (val) => { if (sortableInstance) sortableInstance.option("disabled", !val); });
            
            const initSortable = () => { 
                const el = document.getElementById('itinerary-list'); 
                if(el){ 
                    if(sortableInstance) sortableInstance.destroy();
                    sortableInstance = new Sortable(el, { 
                        animation: 150, 
                        handle: '.itinerary-item', // æŒ‡å®šåªèƒ½æ‹–æ›³é€™å€‹ class
                        disabled: !isDraggable.value, 
                        onEnd: (evt) => { 
                            const item = schedule.value[currentDayIndex.value].events.splice(evt.oldIndex, 1)[0]; 
                            schedule.value[currentDayIndex.value].events.splice(evt.newIndex, 0, item); 
                        } 
                    }); 
                } 
            };
            watch(currentDayIndex, () => { 
                setTimeout(initSortable, 100); 
                fetchWeather(); 
            });

            // è¼”åŠ©å‡½å¼
            const getDayName = (d) => new Date(d).toLocaleDateString('en-US', { weekday: 'short' });
            const getDayNum = (d) => new Date(d).getDate();
            const getCategoryIcon = (c) => ({ flight:'fa-plane', hotel:'fa-bed', spot:'fa-camera', food:'fa-utensils', shop:'fa-bag-shopping', transport:'fa-train', ticket:'fa-ticket', other:'fa-star' }[c] || 'fa-circle');
            const getCategoryColor = (c) => ({ flight:'bg-blue-400', hotel:'bg-indigo-400', spot:'bg-pink-400', food:'bg-orange-400', shop:'bg-yellow-400', transport:'bg-green-400' }[c] || 'bg-gray-400');
            const getTransportIcon = (t) => { const map={walk:'fa-person-walking', subway:'fa-train-subway', train:'fa-train', hsr:'fa-train', tram:'fa-train-tram', taxi:'fa-taxi', bus:'fa-bus'}; return `fas ${map[t]||'fa-person-walking'}`; };
            const getWeatherIcon = () => 'fas fa-snowflake';
            
            // ä¿®æ­£åœ°åœ–é€£çµï¼šä½¿ç”¨ Google Maps Search API
            const getMapLink = (name) => `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(name)}`;

            // --- Canvas ç©é›ªå‹•ç•« (ä¿æŒåŽŸæ¨£) ---
            const bannerRef = ref(null);
            let canvas, ctx, animationId;
            const flakes = [];
            const snowPileHeight = new Array(480).fill(0);
            const initCanvas = () => { 
                canvas = document.getElementById('snow-canvas'); 
                if (!canvas) return; 
                const resize = () => { 
                    canvas.width = canvas.parentElement.offsetWidth; 
                    canvas.height = canvas.parentElement.offsetHeight; 
                    if (snowPileHeight.length !== canvas.width) { 
                        const oldLen = snowPileHeight.length;
                        snowPileHeight.length = canvas.width; 
                        for(let i=oldLen; i<canvas.width; i++) snowPileHeight[i] = 0; 
                    } 
                }; 
                window.addEventListener('resize', resize); 
                resize(); 
                for (let i = 0; i < 50; i++) { flakes.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, r: Math.random() * 2 + 1, d: Math.random() * 0.5 + 0.2 }); } 
                animateSnow(); 
            };
            const animateSnow = () => { 
                if (!canvas) return; 
                ctx = canvas.getContext('2d'); 
                ctx.clearRect(0, 0, canvas.width, canvas.height); 
                
                // Draw Pile
                ctx.fillStyle = "rgba(255, 255, 255, 0.95)"; 
                ctx.beginPath(); 
                ctx.moveTo(0, canvas.height); 
                for (let i = 0; i < canvas.width; i++) { let h = snowPileHeight[i]; ctx.lineTo(i, canvas.height - h); } 
                ctx.lineTo(canvas.width, canvas.height); 
                ctx.fill(); 
                
                // Draw Flakes
                ctx.fillStyle = "rgba(255, 255, 255, 0.8)"; 
                ctx.beginPath(); 
                for (let i = 0; i < flakes.length; i++) { const f = flakes[i]; ctx.moveTo(f.x, f.y); ctx.arc(f.x, f.y, f.r, 0, Math.PI * 2, true); } 
                ctx.fill(); 
                
                updateFlakes(); 
                animationId = requestAnimationFrame(animateSnow); 
            };
            const updateFlakes = () => { 
                for (let i = 0; i < flakes.length; i++) { 
                    const f = flakes[i]; 
                    f.y += Math.pow(f.d, 2) * 0.5 + 0.3; 
                    f.x += Math.sin(f.y * 0.05) * 0.3; 
                    const floorIndex = Math.floor(f.x); 
                    if (floorIndex >= 0 && floorIndex < canvas.width) { 
                        const pileHeight = snowPileHeight[floorIndex] || 0; 
                        if (f.y + f.r >= canvas.height - pileHeight) { 
                            if (pileHeight < 25) { 
                                for(let k = -2; k <= 2; k++) { 
                                    if (floorIndex + k >= 0 && floorIndex + k < canvas.width) { 
                                        snowPileHeight[floorIndex + k] = (snowPileHeight[floorIndex + k] || 0) + 0.4 * (3 - Math.abs(k)); 
                                    } 
                                } 
                            } 
                            resetFlake(f); 
                        } 
                    } else if (f.y > canvas.height) { resetFlake(f); } 
                } 
            };
            const resetFlake = (f) => { f.y = -10; f.x = Math.random() * canvas.width; };
            onUnmounted(() => { cancelAnimationFrame(animationId); });

            return {
                // State
                currentTab, currentDayIndex, schedule, showModal, modalType, isEditing, 
                editForm, shoppingForm, expenseForm, shoppingList, expenses, 
                converter, weather, settings, members, hotels, packingList: currentChecklistData,
                currentChecklistMember, currentChecklistData, isDraggable, bannerRef,
                
                // Computed
                totalExpenses, modalTitle, showSettlement, settlementPlan, packingProgress,
                
                // Methods
                toggleDraggable, handleAddClick, openAddModal, editEvent, saveData, 
                confirmDelete, deleteShoppingItem, handleImageUpload,
                calculateTWD, calculateJPY, toggleSettlement, 
                addMember, removeMember, renameMember, toggleAllInvolved,
                
                // Display Helpers
                getDayName, getDayNum, getCategoryIcon, getCategoryColor, 
                getTransportIcon, getWeatherIcon, getMapLink
            };
        }
    }).mount('#app');
</script>
