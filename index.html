<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Japan Winter Trip 2025</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            /* 字體修改：應用 Zen Maru Gothic */
            font-family: 'Zen Maru Gothic', sans-serif;
            background-color: #dcebf6;
            color: #334155;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
        }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .app-container {
            max-width: 480px;
            margin: 0 auto;
            min-height: 100vh;
            background-color: #f8fafc;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
            padding-bottom: 80px;
            overflow-x: hidden; /* 防止雪花飄出邊界 */
        }

        .curved-content {
            border-radius: 2rem 2rem 0 0;
            margin-top: -30px;
            position: relative;
            z-index: 10;
            background-color: #f8fafc;
            padding-top: 1.5rem;
            min-height: 500px;
        }

        /* --- ICON 優化 --- */
        .nav-tabs {
            position: absolute;
            bottom: 35px; /* 稍微往下移一點點 */
            right: 15px;
            display: flex;
            gap: 10px; /* 間距稍微縮小 */
            z-index: 20;
        }
        .nav-tab-btn {
            width: 40px; /* 尺寸縮小 (原 45px) */
            height: 40px; /* 尺寸縮小 (原 45px) */
            border-radius: 50%;
            /* 背景變得更透明 */
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(4px);
            /* 邊框變得更細、更淡 */
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem; /* 字體稍微縮小 */
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        /* 選中狀態才變明顯 */
        .nav-tab-btn.active {
            background: #ffffff;
            color: #3B82F6;
            border-color: #ffffff;
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            opacity: 1;
        }

        /* --- 雪花動畫 --- */
        .snowflake {
            position: absolute;
            top: -10px;
            background-color: #fff;
            border-radius: 50%;
            opacity: 0.8;
            pointer-events: none; /* 不會擋住滑鼠點擊 */
            animation: snowfall linear infinite;
        }

        @keyframes snowfall {
            0% {
                transform: translateY(0) translateX(0) rotate(0deg);
                opacity: 0.8;
            }
            100% {
                /* 飄落到 280px (Banner 高度) 的位置 */
                transform: translateY(280px) translateX(20px) rotate(360deg); 
                opacity: 0.2;
            }
        }

        /* 其他原有樣式保持不變 */
        .timeline-line {
            position: absolute;
            left: 19px;
            top: 45px;
            bottom: -20px;
            width: 2px;
            background-color: #e2e8f0;
            z-index: 0;
        }
        .boarding-pass {
            background: linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%);
            border: 1px solid #cbd5e1;
            position: relative;
            overflow: hidden;
        }
        .boarding-pass::before, .boarding-pass::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 20px;
            height: 20px;
            background-color: #f8fafc;
            border-radius: 50%;
            border: 1px solid #cbd5e1;
            transform: translateY(-50%);
        }
        .boarding-pass::before { left: -11px; border-right-color: transparent; border-top-color: transparent; border-bottom-color: transparent; transform: translateY(-50%) rotate(45deg); }
        .boarding-pass::after { right: -11px; border-left-color: transparent; border-top-color: transparent; border-bottom-color: transparent; transform: translateY(-50%) rotate(-45deg); }
    </style>
</head>
<body>

<div id="app">
    <div class="app-container">
        
        <div class="relative h-[280px] w-full overflow-hidden">
            <img src="banner.jpg" alt="Banner" class="w-full h-full object-cover">
            <div class="absolute inset-0 bg-gradient-to-t from-black/30 via-transparent to-transparent"></div>
            
            <div v-for="n in 30" :key="n" class="snowflake" :style="getSnowStyle()"></div>

            <div class="nav-tabs">
                <button @click="currentTab = 'schedule'" :class="['nav-tab-btn', currentTab === 'schedule' ? 'active' : '']">
                    <i class="fas fa-map-location-dot"></i>
                </button>
                <button @click="currentTab = 'info'" :class="['nav-tab-btn', currentTab === 'info' ? 'active' : '']">
                    <i class="fas fa-circle-info"></i>
                </button>
                <button @click="currentTab = 'shopping'" :class="['nav-tab-btn', currentTab === 'shopping' ? 'active' : '']">
                    <i class="fas fa-basket-shopping"></i>
                </button>
                <button @click="currentTab = 'expenses'" :class="['nav-tab-btn', currentTab === 'expenses' ? 'active' : '']">
                    <i class="fas fa-yen-sign"></i>
                </button>
            </div>
        </div>

        <div class="curved-content px-5">

            <div v-show="currentTab === 'schedule'">
                <div v-if="weather" class="mb-4 bg-blue-50/80 rounded-xl p-3 flex items-center justify-between border border-blue-100 shadow-sm">
                    <div class="flex items-center gap-3">
                        <i :class="getWeatherIcon(weather.code)" class="text-3xl text-blue-500"></i>
                        <div>
                            <div class="text-sm font-bold text-gray-700">{{ schedule[currentDayIndex].location }}</div>
                            <div class="text-xs text-gray-500">{{ weather.desc }}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl font-bold text-gray-800">{{ weather.temp }}°</div>
                        <div class="text-xs text-gray-400">體感 {{ weather.feelsLike }}°</div>
                    </div>
                </div>

                <div class="flex space-x-3 overflow-x-auto hide-scrollbar mb-6 pb-2">
                    <button 
                        v-for="(day, index) in schedule" 
                        :key="index"
                        @click="currentDayIndex = index"
                        class="flex-shrink-0 flex flex-col items-center justify-center w-14 h-16 rounded-xl transition-all border"
                        :class="currentDayIndex === index ? 'bg-blue-600 text-white shadow-lg scale-105 border-blue-600' : 'bg-white text-gray-400 border-gray-100'"
                    >
                        <span class="text-xs uppercase font-bold">{{ getDayName(day.date) }}</span>
                        <span class="text-lg font-bold">{{ getDayNum(day.date) }}</span>
                    </button>
                </div>

                <div id="itinerary-list" class="space-y-0 relative pb-20">
                    <div v-for="(item, idx) in schedule[currentDayIndex].events" :key="item.id" class="relative group itinerary-item pb-6" :data-id="item.id">
                        
                        <div v-if="idx < schedule[currentDayIndex].events.length - 1" class="absolute left-[19px] top-10 bottom-0 w-[2px] bg-gray-200 z-0 flex flex-col items-center justify-center">
                            <div class="bg-gray-100 text-[10px] text-gray-500 px-1 py-0.5 rounded border border-gray-200 mt-4 whitespace-nowrap z-10">
                                <i :class="getTransportIcon(item.transportType)"></i> {{ item.transportTime }}
                            </div>
                        </div>

                        <div v-if="item.category === 'flight' && idx === 0" class="pl-0 mb-4">
                            <div class="boarding-pass rounded-2xl p-4 shadow-sm relative">
                                <div class="flex justify-between items-center mb-3 border-b border-dashed border-gray-300 pb-2">
                                    <div class="text-blue-600 font-bold tracking-widest">FLIGHT</div>
                                    <div class="text-gray-400 text-xs">{{ item.date }}</div>
                                </div>
                                <div class="flex justify-between items-center">
                                    <div class="text-center">
                                        <div class="text-3xl font-bold text-gray-800">{{ item.depCode || 'TPE' }}</div>
                                        <div class="text-xs text-gray-500">{{ item.startTime }}</div>
                                    </div>
                                    <div class="flex-1 flex flex-col items-center px-2">
                                        <i class="fas fa-plane text-gray-300 transform rotate-90"></i>
                                        <div class="text-[10px] text-gray-400 mt-1">{{ item.duration || '飛行中' }}</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-3xl font-bold text-gray-800">{{ item.arrCode || 'CTS' }}</div>
                                        <div class="text-xs text-gray-500">{{ item.endTime }}</div>
                                    </div>
                                </div>
                                <div class="mt-3 text-center text-sm font-medium text-gray-600 bg-gray-50 py-1 rounded">
                                    {{ item.name }}
                                </div>
                            </div>
                        </div>

                        <div v-else class="relative pl-12 cursor-pointer" @click="editEvent(item)">
                            <div class="absolute left-0 top-0 w-10 h-10 rounded-full flex items-center justify-center text-white shadow-md z-10 border-2 border-white"
                                 :class="getCategoryColor(item.category)">
                                <i :class="getCategoryIcon(item.category)"></i>
                            </div>

                            <div class="bg-white rounded-xl p-3 shadow-sm border border-gray-100 hover:shadow-md transition active:scale-95">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-gray-800 text-lg">{{ item.name }}</h3>
                                    <a :href="getMapLink(item.name)" @click.stop target="_blank" class="text-blue-500 bg-blue-50 w-8 h-8 rounded-full flex items-center justify-center">
                                        <i class="fas fa-location-arrow"></i>
                                    </a>
                                </div>
                                
                                <div class="mt-1 flex flex-wrap gap-2 text-xs text-gray-500">
                                    <span v-if="item.startTime" class="bg-gray-100 px-2 py-1 rounded"><i class="far fa-clock mr-1"></i>{{ item.startTime }}~{{item.endTime}}</span>
                                    <span v-if="item.category === 'spot' && item.cost" class="bg-yellow-50 text-yellow-600 px-2 py-1 rounded"><i class="fas fa-ticket-alt mr-1"></i>{{ item.cost }}</span>
                                </div>

                                <p v-if="item.notes" class="mt-2 text-sm text-gray-500 border-l-2 border-gray-200 pl-2 line-clamp-2">
                                    {{ item.notes }}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <button @click="openAddModal('schedule')" class="fixed bottom-6 right-6 w-14 h-14 bg-blue-600 text-white rounded-full shadow-xl flex items-center justify-center text-2xl z-40 hover:scale-110 transition">
                    <i class="fas fa-plus"></i>
                </button>
            </div>

            <div v-show="currentTab === 'info'" class="space-y-6 pb-20">
                
                <div class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100">
                    <h3 class="font-bold text-gray-800 mb-3"><i class="fas fa-coins text-yellow-500 mr-2"></i>匯率換算 (JPY → TWD)</h3>
                    <div class="flex items-center gap-3">
                        <div class="flex-1">
                            <label class="text-xs text-gray-400 block mb-1">日幣 (JPY)</label>
                            <input type="number" v-model="converter.jpy" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-lg font-bold" placeholder="0">
                        </div>
                        <i class="fas fa-arrow-right text-gray-300 mt-4"></i>
                        <div class="flex-1">
                            <label class="text-xs text-gray-400 block mb-1">台幣 (TWD)</label>
                            <div class="w-full bg-blue-50 border border-blue-100 text-blue-800 rounded-lg px-3 py-2 text-lg font-bold">
                                {{ (converter.jpy * 0.22).toFixed(0) }}
                            </div>
                        </div>
                    </div>
                    <p class="text-[10px] text-gray-400 mt-2 text-right">以匯率 0.22 概算</p>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="bg-blue-600 px-4 py-2 text-white text-sm font-bold flex justify-between items-center">
                        <span><i class="fas fa-plane mr-2"></i>航班資訊</span>
                    </div>
                    <div class="p-4 border-b border-gray-100">
                        <div class="flex justify-between mb-2">
                            <span class="text-xs bg-blue-100 text-blue-600 px-2 py-0.5 rounded font-bold">去程</span>
                            <span class="text-xs text-gray-500">2025/12/24</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <div class="text-center">
                                <div class="text-2xl font-black text-gray-800">TPE</div>
                                <div class="text-xs text-gray-500">08:00</div>
                            </div>
                            <div class="flex-1 flex flex-col items-center px-2">
                                <div class="text-xs text-gray-400 mb-1">BR116</div>
                                <div class="w-full h-[1px] bg-gray-300 relative">
                                    <i class="fas fa-plane absolute top-1/2 left-1/2 transform -translate-y-1/2 -translate-x-1/2 text-gray-400 text-xs"></i>
                                </div>
                                <div class="text-[10px] text-gray-400 mt-1">3h 35m</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-black text-gray-800">CTS</div>
                                <div class="text-xs text-gray-500">12:35</div>
                            </div>
                        </div>
                    </div>
                    <div class="p-4">
                        <div class="flex justify-between mb-2">
                            <span class="text-xs bg-green-100 text-green-600 px-2 py-0.5 rounded font-bold">回程</span>
                            <span class="text-xs text-gray-500">2026/01/04</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <div class="text-center">
                                <div class="text-2xl font-black text-gray-800">NRT</div>
                                <div class="text-xs text-gray-500">14:00</div>
                            </div>
                            <div class="flex-1 flex flex-col items-center px-2">
                                <div class="text-xs text-gray-400 mb-1">JX801</div>
                                <div class="w-full h-[1px] bg-gray-300 relative">
                                    <i class="fas fa-plane absolute top-1/2 left-1/2 transform -translate-y-1/2 -translate-x-1/2 text-gray-400 text-xs rotate-180"></i>
                                </div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-black text-gray-800">TPE</div>
                                <div class="text-xs text-gray-500">17:15</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <div class="w-8 h-8 bg-indigo-100 text-indigo-600 rounded-lg flex items-center justify-center mb-2"><i class="fas fa-bed"></i></div>
                        <h4 class="font-bold text-gray-700">札幌王子飯店</h4>
                        <p class="text-xs text-gray-400 mt-1">+81-11-241-1111</p>
                        <a href="https://maps.google.com" target="_blank" class="text-[10px] text-blue-500 mt-2 block">導航 ></a>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <div class="w-8 h-8 bg-orange-100 text-orange-600 rounded-lg flex items-center justify-center mb-2"><i class="fas fa-car"></i></div>
                        <h4 class="font-bold text-gray-700">TOYOTA 租車</h4>
                        <p class="text-xs text-gray-400 mt-1">預約號: T123456</p>
                        <a href="https://maps.google.com" target="_blank" class="text-[10px] text-blue-500 mt-2 block">取車點 ></a>
                    </div>
                </div>
            </div>

            <div v-show="currentTab === 'shopping'" class="pb-20">
                <h3 class="font-bold text-xl text-gray-800 mb-4">購物清單 <span class="text-sm font-normal text-gray-400">({{ shoppingList.length }})</span></h3>
                
                <div class="grid grid-cols-2 gap-3">
                    <div v-for="(item, idx) in shoppingList" :key="idx" class="bg-white rounded-xl overflow-hidden shadow-sm border border-gray-100 relative group">
                        <button @click="deleteShoppingItem(idx)" class="absolute top-2 right-2 bg-red-500 text-white w-6 h-6 rounded-full text-xs flex items-center justify-center opacity-0 group-hover:opacity-100 transition z-10"><i class="fas fa-times"></i></button>
                        <div class="h-32 bg-gray-100 relative">
                            <img v-if="item.image" :src="item.image" class="w-full h-full object-cover">
                            <div v-else class="absolute inset-0 flex items-center justify-center text-gray-300"><i class="fas fa-image text-2xl"></i></div>
                        </div>
                        <div class="p-3">
                            <div class="font-bold text-gray-700 truncate">{{ item.name }}</div>
                            <div class="flex items-center gap-1 text-xs text-gray-400 mt-1">
                                <input type="checkbox" v-model="item.checked" class="rounded text-blue-500">
                                <span>已購買</span>
                            </div>
                        </div>
                    </div>
                </div>
                <button @click="openAddModal('shopping')" class="fixed bottom-6 right-6 w-14 h-14 bg-pink-500 text-white rounded-full shadow-xl flex items-center justify-center text-2xl z-40 hover:scale-110 transition">
                    <i class="fas fa-plus"></i>
                </button>
            </div>

            <div v-show="currentTab === 'expenses'" class="pb-20">
                <div class="bg-gradient-to-r from-slate-700 to-slate-800 rounded-2xl p-5 text-white shadow-lg mb-6">
                    <div class="text-sm opacity-70">總花費 (JPY)</div>
                    <div class="text-3xl font-bold mt-1">¥ {{ totalExpenses.toLocaleString() }}</div>
                    <div class="text-xs opacity-60 mt-1">約 TWD {{ (totalExpenses * 0.22).toFixed(0).toLocaleString() }}</div>
                </div>

                <div class="space-y-3">
                    <div v-for="(expense, idx) in expenses" :key="idx" class="bg-white rounded-xl p-3 flex items-center justify-between shadow-sm border border-gray-100">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center text-white text-sm"
                                 :class="getCategoryColor(expense.category)">
                                <i :class="getCategoryIcon(expense.category)"></i>
                            </div>
                            <div>
                                <div class="font-bold text-gray-800">{{ expense.name }}</div>
                                <div class="text-xs text-gray-400">{{ expense.date }} • {{ expense.payment }}</div>
                            </div>
                        </div>
                        <div class="font-bold text-gray-700">¥{{ expense.amount }}</div>
                    </div>
                </div>
                <button @click="openAddModal('expense')" class="fixed bottom-6 right-6 w-14 h-14 bg-yellow-500 text-white rounded-full shadow-xl flex items-center justify-center text-2xl z-40 hover:scale-110 transition">
                    <i class="fas fa-plus"></i>
                </button>
            </div>

        </div>

        <div v-if="showModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-fade-in">
            <div class="bg-white w-full max-w-sm rounded-2xl p-5 shadow-2xl transform transition-all scale-100">
                <h3 class="text-lg font-bold mb-4">{{ modalTitle }}</h3>
                
                <div v-if="modalType === 'schedule'" class="space-y-3">
                    <select v-model="editForm.category" class="w-full p-2 border rounded-lg bg-gray-50">
                        <option value="spot">景點</option>
                        <option value="food">美食</option>
                        <option value="shop">購物</option>
                        <option value="hotel">住宿</option>
                        <option value="flight">航班</option>
                    </select>
                    <input v-model="editForm.name" placeholder="名稱" class="w-full p-2 border rounded-lg">
                    <div class="flex gap-2">
                        <input v-model="editForm.startTime" type="time" class="w-1/2 p-2 border rounded-lg">
                        <input v-model="editForm.endTime" type="time" class="w-1/2 p-2 border rounded-lg">
                    </div>
                    <input v-if="editForm.category === 'spot'" v-model="editForm.cost" placeholder="門票價格" class="w-full p-2 border rounded-lg">
                    
                    <div class="bg-gray-50 p-2 rounded-lg">
                        <label class="text-xs text-gray-500">前往下一站的交通</label>
                        <div class="flex gap-2 mt-1">
                            <select v-model="editForm.transportType" class="p-1 text-sm border rounded">
                                <option value="walk">步行</option>
                                <option value="train">大眾運輸</option>
                                <option value="car">開車</option>
                            </select>
                            <input v-model="editForm.transportTime" placeholder="例如: 15分" class="flex-1 p-1 text-sm border rounded">
                        </div>
                    </div>

                    <textarea v-model="editForm.notes" placeholder="備註" class="w-full p-2 border rounded-lg h-20"></textarea>
                </div>

                <div v-if="modalType === 'shopping'" class="space-y-3">
                    <input v-model="shoppingForm.name" placeholder="商品名稱" class="w-full p-2 border rounded-lg">
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:bg-gray-50 relative">
                        <input type="file" @change="handleImageUpload" class="absolute inset-0 opacity-0 cursor-pointer">
                        <span class="text-gray-400 text-sm"><i class="fas fa-camera mr-1"></i> 上傳圖片</span>
                    </div>
                </div>

                <div v-if="modalType === 'expense'" class="space-y-3">
                    <select v-model="expenseForm.category" class="w-full p-2 border rounded-lg bg-gray-50">
                        <option value="food">飲食</option>
                        <option value="transport">交通</option>
                        <option value="shop">購物</option>
                        <option value="ticket">門票</option>
                        <option value="hotel">住宿</option>
                        <option value="other">其他</option>
                    </select>
                    <input v-model="expenseForm.name" placeholder="項目名稱" class="w-full p-2 border rounded-lg">
                    <input v-model="expenseForm.amount" type="number" placeholder="金額 (日幣)" class="w-full p-2 border rounded-lg">
                    <select v-model="expenseForm.payment" class="w-full p-2 border rounded-lg">
                        <option value="現金">現金</option>
                        <option value="信用卡">信用卡</option>
                        <option value="Suica/IC">西瓜卡</option>
                    </select>
                </div>

                <div class="flex gap-3 mt-6">
                    <button v-if="isEditing" @click="confirmDelete" class="flex-1 bg-red-100 text-red-500 py-2 rounded-lg font-bold">刪除</button>
                    <button @click="showModal = false" class="flex-1 bg-gray-100 text-gray-500 py-2 rounded-lg font-bold">取消</button>
                    <button @click="saveData" class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-bold">儲存</button>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    const { createApp, ref, computed, onMounted, watch } = Vue;

    createApp({
        setup() {
            const currentTab = ref('schedule');
            const currentDayIndex = ref(0);
            const showModal = ref(false);
            const modalType = ref(''); // schedule, shopping, expense
            const isEditing = ref(false);
            const converter = ref({ jpy: 1000 });
            const weather = ref(null);

            // 初始資料
            const schedule = ref([
                {
                    date: "2025-12-24", location: "Tokyo",
                    events: [
                        { id: 1, category: 'flight', name: '前往東京', startTime: '08:00', endTime: '12:35', depCode: 'TPE', arrCode: 'CTS', transportType: 'train', transportTime: '45分' },
                        { id: 2, category: 'hotel', name: '東京王子飯店', startTime: '15:00', endTime: '', notes: 'Check-in', transportType: 'walk', transportTime: '10分' },
                        { id: 3, category: 'spot', name: '六本木聖誕燈飾', startTime: '18:00', endTime: '20:00', cost: '免費', notes: '櫸坂通點燈', transportType: 'walk', transportTime: '-' }
                    ]
                },
                {
                    date: "2025-12-25", location: "Tokyo",
                    events: [
                        { id: 10, category: 'spot', name: '迪士尼樂園', startTime: '09:00', endTime: '21:00', cost: '¥9400', notes: '聖誕遊行必看', transportType: 'train', transportTime: '30分' }
                    ]
                },
                { date: "2025-12-26", location: "Tokyo", events: [] },
                { date: "2025-12-27", location: "Sapporo", events: [] },
                { date: "2025-12-28", location: "Sapporo", events: [] }
            ]);

            const shoppingList = ref([]);
            const expenses = ref([]);

            // 表單 Data
            const editForm = ref({});
            const shoppingForm = ref({});
            const expenseForm = ref({});

            // 初始化與 LocalStorage 讀取
            onMounted(() => {
                const savedData = localStorage.getItem('tripData');
                if (savedData) {
                    const parsed = JSON.parse(savedData);
                    schedule.value = parsed.schedule;
                    shoppingList.value = parsed.shoppingList || [];
                    expenses.value = parsed.expenses || [];
                }

                initSortable();
                fetchWeather();
            });

            // 自動存檔
            watch([schedule, shoppingList, expenses], () => {
                localStorage.setItem('tripData', JSON.stringify({
                    schedule: schedule.value,
                    shoppingList: shoppingList.value,
                    expenses: expenses.value
                }));
            }, { deep: true });

            // 拖曳排序初始化
            const initSortable = () => {
                const el = document.getElementById('itinerary-list');
                if(el) {
                    new Sortable(el, {
                        animation: 150,
                        handle: '.itinerary-item', // 整個卡片可拖
                        onEnd: function (evt) {
                            const item = schedule.value[currentDayIndex.value].events.splice(evt.oldIndex, 1)[0];
                            schedule.value[currentDayIndex.value].events.splice(evt.newIndex, 0, item);
                        }
                    });
                }
            };

            // 監聽日期切換，重新綁定 Sortable (因為 DOM 變了)
            watch(currentDayIndex, () => {
                setTimeout(initSortable, 100);
                fetchWeather(); // 切換日期/地點時更新天氣
            });

            // 天氣 API (Open-Meteo)
            const fetchWeather = async () => {
                const loc = schedule.value[currentDayIndex.value].location;
                // 簡單定義座標
                const coords = loc === 'Tokyo' ? {lat: 35.6895, lon: 139.6917} : {lat: 43.0618, lon: 141.3545};
                
                try {
                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${coords.lat}&longitude=${coords.lon}&current_weather=true`);
                    const data = await res.json();
                    const code = data.current_weather.weathercode;
                    weather.value = {
                        temp: data.current_weather.temperature,
                        feelsLike: data.current_weather.temperature - 2, // 簡易模擬
                        code: code,
                        desc: getWeatherDesc(code)
                    };
                } catch (e) { console.log("Weather error", e); }
            };

            // 工具函式
            const getDayName = (dateStr) => {
                const d = new Date(dateStr);
                return d.toLocaleDateString('en-US', { weekday: 'short' });
            };
            const getDayNum = (dateStr) => {
                return new Date(dateStr).getDate();
            };
            const getCategoryIcon = (cat) => {
                const map = { flight: 'fa-plane', hotel: 'fa-bed', spot: 'fa-camera', food: 'fa-utensils', shop: 'fa-bag-shopping', transport: 'fa-train', ticket: 'fa-ticket', other: 'fa-star' };
                return `fas ${map[cat] || 'fa-circle'}`;
            };
            const getCategoryColor = (cat) => {
                const map = { flight: 'bg-blue-400', hotel: 'bg-indigo-400', spot: 'bg-pink-400', food: 'bg-orange-400', shop: 'bg-yellow-400', transport: 'bg-green-400' };
                return map[cat] || 'bg-gray-400';
            };
            const getTransportIcon = (type) => {
                return type === 'walk' ? 'fas fa-person-walking' : type === 'car' ? 'fas fa-car' : 'fas fa-train-subway';
            };
            const getWeatherIcon = (code) => {
                if(code <= 3) return 'fas fa-sun';
                if(code <= 60) return 'fas fa-cloud-rain';
                if(code <= 80) return 'fas fa-snowflake';
                return 'fas fa-cloud';
            };
            const getWeatherDesc = (code) => {
                if(code <= 3) return '晴時多雲';
                if(code <= 60) return '有雨';
                if(code <= 80) return '降雪';
                return '陰天';
            };
            const getMapLink = (name) => `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(name)}`;

            // 產生隨機雪花樣式
            const getSnowStyle = () => {
                const size = Math.random() * 5 + 2; // 2px ~ 7px
                const left = Math.random() * 100; // 0% ~ 100%
                const duration = Math.random() * 5 + 5; // 5s ~ 10s
                const delay = Math.random() * 5; // 0s ~ 5s
                return {
                    width: `${size}px`,
                    height: `${size}px`,
                    left: `${left}%`,
                    animationDuration: `${duration}s`,
                    animationDelay: `${delay}s`,
                    opacity: Math.random() * 0.6 + 0.2 // 0.2 ~ 0.8
                };
            };

            const totalExpenses = computed(() => {
                return expenses.value.reduce((sum, item) => sum + Number(item.amount), 0);
            });

            const modalTitle = computed(() => {
                if (modalType.value === 'schedule') return isEditing.value ? '編輯行程' : '新增行程';
                if (modalType.value === 'shopping') return '新增購物清單';
                if (modalType.value === 'expense') return '新增花費';
                return '';
            });

            // Modal 操作
            const openAddModal = (type) => {
                modalType.value = type;
                isEditing.value = false;
                editForm.value = { category: 'spot', transportType: 'train', transportTime: '20分' }; // reset
                shoppingForm.value = {};
                expenseForm.value = { category: 'food', payment: '現金', date: schedule.value[currentDayIndex.value].date };
                showModal.value = true;
            };

            const editEvent = (item) => {
                if(item.category === 'flight') return; // 航班暫不編輯
                modalType.value = 'schedule';
                isEditing.value = true;
                editForm.value = JSON.parse(JSON.stringify(item)); // Deep copy
                showModal.value = true;
            };

            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => shoppingForm.value.image = e.target.result;
                    reader.readAsDataURL(file);
                }
            };

            const saveData = () => {
                if (modalType.value === 'schedule') {
                    if (isEditing.value) {
                        const idx = schedule.value[currentDayIndex.value].events.findIndex(e => e.id === editForm.value.id);
                        if (idx !== -1) schedule.value[currentDayIndex.value].events[idx] = editForm.value;
                    } else {
                        editForm.value.id = Date.now();
                        schedule.value[currentDayIndex.value].events.push(editForm.value);
                    }
                } else if (modalType.value === 'shopping') {
                    shoppingList.value.push(shoppingForm.value);
                } else if (modalType.value === 'expense') {
                    expenses.value.push(expenseForm.value);
                }
                showModal.value = false;
            };

            const confirmDelete = () => {
                if(confirm("確定要刪除此行程嗎？")) {
                    const idx = schedule.value[currentDayIndex.value].events.findIndex(e => e.id === editForm.value.id);
                    if (idx !== -1) schedule.value[currentDayIndex.value].events.splice(idx, 1);
                    showModal.value = false;
                }
            };

            const deleteShoppingItem = (idx) => {
                if(confirm("刪除此商品？")) shoppingList.value.splice(idx, 1);
            };

            return {
                currentTab, currentDayIndex, schedule, showModal, modalType, isEditing, modalTitle,
                editForm, shoppingForm, expenseForm, shoppingList, expenses, converter, weather,
                totalExpenses,
                openAddModal, editEvent, saveData, confirmDelete, deleteShoppingItem, handleImageUpload,
                getDayName, getDayNum, getCategoryIcon, getCategoryColor, getTransportIcon, getWeatherIcon, getMapLink, getSnowStyle
            };
        }
    }).mount('#app');
</script>

</body>
</html>
