<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Japan Winter Trip 2025-26</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            background-color: #f8fafc;
            color: #334155;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
        }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .app-container {
            max-width: 480px;
            margin: 0 auto;
            min-height: 100vh;
            background-color: #f8fafc;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
            padding-bottom: 80px;
            overflow-x: hidden;
        }

        /* ÂÖßÂÆπÂçÄÂüü */
        .content-area {
            position: relative;
            z-index: 10;
            background-color: #f8fafc;
            padding-top: 0.5rem; 
            min-height: 500px;
        }

        /* --- Âè≥ÂÅ¥Â∞éËà™ ICON ‰ΩçÁΩÆ (Bottom 8px) --- */
        .nav-tabs {
            position: absolute;
            bottom: 8px;
            right: 15px;
            display: flex;
            gap: 10px;
            z-index: 20;
        }
        .nav-tab-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            color: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .nav-tab-btn.active {
            background: #ffffff;
            color: #3B82F6;
            border-color: #ffffff;
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            opacity: 1;
        }

        /* --- Â∑¶ÂÅ¥ ÈâõÁ≠Ü ICON --- */
        .edit-mode-btn {
            position: absolute;
            bottom: 8px;
            left: 15px;
            z-index: 20;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            color: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .edit-mode-btn.active {
            background: #ffffff;
            color: #F59E0B;
            border-color: #ffffff;
            transform: scale(1.1);
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            opacity: 1;
        }

        /* --- Â∑¶ÂÅ¥ Êñ∞Â¢ûË°åÁ®ã ICON (Êñ∞‰ΩçÁΩÆ) --- */
        .add-event-btn {
            position: absolute;
            bottom: 8px;
            left: 65px; /* 15px + 40px + 10px gap */
            z-index: 20;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            color: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .add-event-btn:active {
            transform: scale(0.95);
            background: rgba(255, 255, 255, 0.4);
        }

        /* Canvas for Snow Effect */
        #snow-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }

        /* ÂÖ∂‰ªñÊ®£Âºè */
        .timeline-line {
            position: absolute;
            left: 19px;
            top: 45px;
            bottom: -20px;
            width: 2px;
            background-color: #e2e8f0;
            z-index: 0;
        }
        .boarding-pass {
            background: linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%);
            border: 1px solid #cbd5e1;
            position: relative;
            overflow: hidden;
        }
        .boarding-pass::before, .boarding-pass::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 20px;
            height: 20px;
            background-color: #f8fafc;
            border-radius: 50%;
            border: 1px solid #cbd5e1;
            transform: translateY(-50%);
        }
        .boarding-pass::before { left: -11px; border-right-color: transparent; border-top-color: transparent; border-bottom-color: transparent; transform: translateY(-50%) rotate(45deg); }
        .boarding-pass::after { right: -11px; border-left-color: transparent; border-top-color: transparent; border-bottom-color: transparent; transform: translateY(-50%) rotate(-45deg); }
        
        @keyframes shake {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(0.5deg); }
            50% { transform: rotate(0deg); }
            75% { transform: rotate(-0.5deg); }
            100% { transform: rotate(0deg); }
        }
        .draggable-shake {
            animation: shake 0.3s infinite ease-in-out;
            cursor: move;
        }
    </style>
</head>
<body>

<div id="app">
    <div class="app-container">
        
        <div class="relative h-[230px] w-full overflow-hidden" ref="bannerRef">
            <img src="banner.jpg" alt="Banner" class="w-full h-full object-cover object-center">
            
            <canvas id="snow-canvas"></canvas>

            <button @click="toggleDraggable" class="edit-mode-btn" :class="{ 'active': isDraggable }">
                <i class="fas fa-pencil-alt"></i>
            </button>

            <button 
                v-if="currentTab === 'schedule'" 
                @click="openAddModal('schedule')" 
                class="add-event-btn"
            >
                <i class="fas fa-plus"></i>
            </button>

            <div class="nav-tabs">
                <button @click="currentTab = 'schedule'" :class="['nav-tab-btn', currentTab === 'schedule' ? 'active' : '']">
                    <i class="fas fa-map-location-dot"></i>
                </button>
                <button @click="currentTab = 'info'" :class="['nav-tab-btn', currentTab === 'info' ? 'active' : '']">
                    <i class="fas fa-circle-info"></i>
                </button>
                <button @click="currentTab = 'shopping'" :class="['nav-tab-btn', currentTab === 'shopping' ? 'active' : '']">
                    <i class="fas fa-basket-shopping"></i>
                </button>
                <button @click="currentTab = 'expenses'" :class="['nav-tab-btn', currentTab === 'expenses' ? 'active' : '']">
                    <i class="fas fa-yen-sign"></i>
                </button>
            </div>
        </div>

        <div class="content-area px-5">

            <div v-show="currentTab === 'schedule'">
                
                <div class="flex space-x-3 overflow-x-auto hide-scrollbar mb-4 pb-2">
                    <button 
                        v-for="(day, index) in schedule" 
                        :key="index"
                        @click="currentDayIndex = index"
                        class="flex-shrink-0 flex flex-col items-center justify-center w-14 h-16 rounded-xl transition-all border"
                        :class="currentDayIndex === index ? 'bg-blue-600 text-white shadow-lg scale-105 border-blue-600' : 'bg-white text-gray-400 border-gray-100'"
                    >
                        <span class="text-xs uppercase font-bold">{{ getDayName(day.date) }}</span>
                        <span class="text-lg font-bold">{{ getDayNum(day.date) }}</span>
                    </button>
                </div>

                <div v-if="weather" class="mb-6 bg-blue-50/80 rounded-xl p-3 flex items-center justify-between border border-blue-100 shadow-sm">
                    <div class="flex items-center gap-3">
                        <i :class="getWeatherIcon(weather.code)" class="text-3xl text-blue-500"></i>
                        <div>
                            <div class="text-sm font-bold text-gray-700">{{ schedule[currentDayIndex].location }}</div>
                            <div class="text-xs text-gray-500">{{ weather.desc }}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl font-bold text-gray-800">{{ weather.temp }}¬∞</div>
                        <div class="text-xs text-gray-400">È´îÊÑü {{ weather.feelsLike }}¬∞</div>
                    </div>
                </div>

                <div id="itinerary-list" class="space-y-0 relative pb-20">
                    <div v-for="(item, idx) in schedule[currentDayIndex].events" :key="item.id" class="relative group itinerary-item pb-6" :data-id="item.id">
                        
                        <div v-if="idx < schedule[currentDayIndex].events.length - 1" class="absolute left-[19px] top-10 bottom-0 w-[2px] bg-gray-200 z-0 flex flex-col items-center justify-center">
                            <div class="bg-gray-100 text-[10px] text-gray-500 px-1 py-0.5 rounded border border-gray-200 mt-4 whitespace-nowrap z-10 flex items-center gap-1">
                                <i :class="getTransportIcon(item.transportType)"></i> {{ item.transportTime }}
                            </div>
                        </div>

                        <div v-if="item.category === 'flight' && idx === 0" class="pl-0 mb-4">
                            <div class="boarding-pass rounded-2xl p-4 shadow-sm relative">
                                <div class="flex justify-between items-center mb-3 border-b border-dashed border-gray-300 pb-2">
                                    <div class="text-blue-800 font-bold tracking-widest"><i class="fas fa-plane-departure mr-1"></i> ANA</div>
                                    <div class="text-gray-400 text-xs">{{ item.date }}</div>
                                </div>
                                <div class="flex justify-between items-center">
                                    <div class="text-center">
                                        <div class="text-3xl font-bold text-gray-800">{{ item.depCode }}</div>
                                        <div class="text-xs text-gray-500">{{ item.startTime }}</div>
                                    </div>
                                    <div class="flex-1 flex flex-col items-center px-2">
                                        <i class="fas fa-plane text-blue-300 transform rotate-90"></i>
                                        <div class="text-[10px] text-gray-400 mt-1">{{ item.duration || 'È£õË°å‰∏≠' }}</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-3xl font-bold text-gray-800">{{ item.arrCode }}</div>
                                        <div class="text-xs text-gray-500">{{ item.endTime }}</div>
                                    </div>
                                </div>
                                <div class="mt-3 text-center text-sm font-medium text-gray-600 bg-gray-50 py-1 rounded">
                                    {{ item.name }}
                                </div>
                            </div>
                        </div>

                        <div v-else class="relative pl-12 cursor-pointer" 
                             @click="editEvent(item)"
                             :class="{ 'opacity-90': isDraggable }">
                            
                            <div v-if="isDraggable" class="absolute right-2 top-2 text-gray-300 z-20">
                                <i class="fas fa-bars"></i>
                            </div>

                            <div class="absolute left-0 top-0 w-10 h-10 rounded-full flex items-center justify-center text-white shadow-md z-10 border-2 border-white"
                                 :class="[getCategoryColor(item.category), isDraggable ? 'draggable-shake' : '']">
                                <i :class="getCategoryIcon(item.category)"></i>
                            </div>
                            <div class="bg-white rounded-xl p-3 shadow-sm border border-gray-100 hover:shadow-md transition active:scale-95">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-gray-800 text-lg">{{ item.name }}</h3>
                                    <a v-if="!isDraggable" :href="getMapLink(item.name)" @click.stop target="_blank" class="text-blue-500 bg-blue-50 w-8 h-8 rounded-full flex items-center justify-center">
                                        <i class="fas fa-location-arrow"></i>
                                    </a>
                                </div>
                                <div class="mt-1 flex flex-wrap gap-2 text-xs text-gray-500">
                                    <span v-if="item.startTime" class="bg-gray-100 px-2 py-1 rounded"><i class="far fa-clock mr-1"></i>{{ item.startTime }}~{{item.endTime}}</span>
                                    <span v-if="item.category === 'spot' && item.cost" class="bg-yellow-50 text-yellow-600 px-2 py-1 rounded"><i class="fas fa-ticket-alt mr-1"></i>{{ item.cost }}</span>
                                </div>
                                <p v-if="item.notes" class="mt-2 text-sm text-gray-500 border-l-2 border-gray-200 pl-2 line-clamp-2">{{ item.notes }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-show="currentTab === 'info'" class="space-y-6 pb-20">
                <div class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100">
                    <h3 class="font-bold text-gray-800 mb-3"><i class="fas fa-coins text-yellow-500 mr-2"></i>ÂåØÁéáÊèõÁÆó (JPY ‚Üí TWD)</h3>
                    <div class="flex items-center gap-3">
                        <div class="flex-1">
                            <label class="text-xs text-gray-400 block mb-1">Êó•Âπ£ (JPY)</label>
                            <input type="number" v-model="converter.jpy" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-lg font-bold" placeholder="0">
                        </div>
                        <i class="fas fa-arrow-right text-gray-300 mt-4"></i>
                        <div class="flex-1">
                            <label class="text-xs text-gray-400 block mb-1">Âè∞Âπ£ (TWD)</label>
                            <div class="w-full bg-blue-50 border border-blue-100 text-blue-800 rounded-lg px-3 py-2 text-lg font-bold">
                                {{ (converter.jpy * settings.rate).toFixed(0) }}
                            </div>
                        </div>
                    </div>
                    <p class="text-[10px] text-gray-400 mt-2 text-right">‰ª•ÂåØÁéá 0.22 Ê¶ÇÁÆó</p>
                </div>
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="bg-blue-600 px-4 py-2 text-white text-sm font-bold flex justify-between items-center">
                        <span><i class="fas fa-plane mr-2"></i>Ëà™Áè≠Ë≥áË®ä (ANA)</span>
                    </div>
                    <div class="p-4 border-b border-gray-100">
                        <div class="flex justify-between mb-2"><span class="text-xs bg-blue-100 text-blue-600 px-2 py-0.5 rounded font-bold">ÂéªÁ®ã 1</span><span class="text-xs text-gray-500">12/24</span></div>
                        <div class="flex justify-between items-center text-center">
                            <div><div class="text-2xl font-black text-gray-800">TSA</div><div class="text-xs text-gray-500">13:30</div></div>
                            <div class="flex-1 px-2"><i class="fas fa-plane text-gray-300 text-xs"></i><div class="text-[10px] text-gray-400">ANA</div></div>
                            <div><div class="text-2xl font-black text-gray-800">HND</div><div class="text-xs text-gray-500">17:30</div></div>
                        </div>
                        <div class="mt-4 flex justify-between mb-2"><span class="text-xs bg-blue-100 text-blue-600 px-2 py-0.5 rounded font-bold">ÂéªÁ®ã 2</span><span class="text-xs text-gray-500">12/27</span></div>
                        <div class="flex justify-between items-center text-center">
                            <div><div class="text-2xl font-black text-gray-800">HND</div><div class="text-xs text-gray-500">18:00</div></div>
                            <div class="flex-1 px-2"><i class="fas fa-plane text-gray-300 text-xs"></i><div class="text-[10px] text-gray-400">ANA</div></div>
                            <div><div class="text-2xl font-black text-gray-800">CTS</div><div class="text-xs text-gray-500">19:35</div></div>
                        </div>
                    </div>
                    <div class="p-4">
                        <div class="flex justify-between mb-2"><span class="text-xs bg-green-100 text-green-600 px-2 py-0.5 rounded font-bold">ÂõûÁ®ã 1</span><span class="text-xs text-gray-500">01/02</span></div>
                        <div class="flex justify-between items-center text-center">
                            <div><div class="text-2xl font-black text-gray-800">HKD</div><div class="text-xs text-gray-500">11:45</div></div>
                            <div class="flex-1 px-2"><i class="fas fa-plane text-gray-300 rotate-180 text-xs"></i><div class="text-[10px] text-gray-400">ANA</div></div>
                            <div><div class="text-2xl font-black text-gray-800">HND</div><div class="text-xs text-gray-500">13:15</div></div>
                        </div>
                        <div class="mt-4 flex justify-between mb-2"><span class="text-xs bg-green-100 text-green-600 px-2 py-0.5 rounded font-bold">ÂõûÁ®ã 2</span><span class="text-xs text-gray-500">01/04</span></div>
                        <div class="flex justify-between items-center text-center">
                            <div><div class="text-2xl font-black text-gray-800">HND</div><div class="text-xs text-gray-500">12:40</div></div>
                            <div class="flex-1 px-2"><i class="fas fa-plane text-gray-300 rotate-180 text-xs"></i><div class="text-[10px] text-gray-400">ANA</div></div>
                            <div><div class="text-2xl font-black text-gray-800">TSA</div><div class="text-xs text-gray-500">15:50</div></div>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                    <div class="w-8 h-8 bg-indigo-100 text-indigo-600 rounded-lg flex items-center justify-center mb-2"><i class="fas fa-bed"></i></div>
                    <h4 class="font-bold text-gray-700">‰ΩèÂÆøË≥áË®ä</h4>
                    <p class="text-xs text-gray-400 mt-1">Ë´ãÊñºÊ≠§Á¥ÄÈåÑÈ£ØÂ∫óË≥áË®ä</p>
                    <a href="usercontent.com/maps.google.com/2" target="_blank" class="text-[10px] text-blue-500 mt-2 block">Â∞éËà™ ></a>
                </div>
            </div>

            <div v-show="currentTab === 'shopping'" class="pb-20">
                <h3 class="font-bold text-xl text-gray-800 mb-4">Ë≥ºÁâ©Ê∏ÖÂñÆ <span class="text-sm font-normal text-gray-400">({{ shoppingList.length }})</span></h3>
                <div class="grid grid-cols-2 gap-3">
                    <div v-for="(item, idx) in shoppingList" :key="idx" class="bg-white rounded-xl overflow-hidden shadow-sm border border-gray-100 relative group">
                        <button @click="deleteShoppingItem(idx)" class="absolute top-2 right-2 bg-red-500 text-white w-6 h-6 rounded-full text-xs flex items-center justify-center opacity-0 group-hover:opacity-100 transition z-10"><i class="fas fa-times"></i></button>
                        <div class="h-32 bg-gray-100 relative">
                            <img v-if="item.image" :src="item.image" class="w-full h-full object-cover">
                            <div v-else class="absolute inset-0 flex items-center justify-center text-gray-300"><i class="fas fa-image text-2xl"></i></div>
                        </div>
                        <div class="p-3">
                            <div class="font-bold text-gray-700 truncate">{{ item.name }}</div>
                            <div class="flex items-center gap-1 text-xs text-gray-400 mt-1"><input type="checkbox" v-model="item.checked" class="rounded text-blue-500"><span>Â∑≤Ë≥ºË≤∑</span></div>
                        </div>
                    </div>
                </div>
                <button @click="openAddModal('shopping')" class="fixed bottom-6 right-6 w-14 h-14 bg-pink-500 text-white rounded-full shadow-xl flex items-center justify-center text-2xl z-40 hover:scale-110 transition"><i class="fas fa-plus"></i></button>
            </div>

            <div v-show="currentTab === 'expenses'" class="pb-20">
                <div class="bg-gradient-to-r from-slate-700 to-slate-800 rounded-2xl p-5 text-white shadow-lg mb-6">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="text-sm opacity-70">Á∏ΩÂÖ¨Ë≤ª (JPY)</div>
                            <div class="text-3xl font-bold mt-1">¬• {{ totalExpenses.toLocaleString() }}</div>
                            <div class="text-xs opacity-60 mt-1">Á¥Ñ TWD {{ (totalExpenses * settings.rate).toFixed(0).toLocaleString() }}</div>
                        </div>
                        <button @click="toggleSettlement" class="bg-white/20 text-xs px-3 py-1 rounded backdrop-blur-sm hover:bg-white/30 transition">
                            <i class="fas fa-calculator mr-1"></i>ÁµêÁÆóÂ†±Ë°®
                        </button>
                    </div>
                </div>

                <div v-if="showSettlement" class="bg-blue-50 rounded-2xl p-4 border border-blue-100 mb-6 animate-fade-in">
                    <h4 class="font-bold text-blue-800 mb-3"><i class="fas fa-file-invoice-dollar mr-2"></i>ÂàÜÂ∏≥Âª∫Ë≠∞</h4>
                    <div v-if="settlementPlan.length === 0" class="text-sm text-gray-500 text-center py-2">ÁõÆÂâçÁµêÈ§òÂπ≥Ë°°ÔºåÁÑ°ÈúÄËΩâÂ∏≥</div>
                    <div v-else class="space-y-2">
                        <div v-for="(plan, idx) in settlementPlan" :key="idx" class="flex justify-between items-center bg-white p-3 rounded-lg shadow-sm">
                            <div class="flex items-center gap-2">
                                <span class="font-bold text-gray-700">{{ plan.from }}</span>
                                <i class="fas fa-arrow-right text-gray-400 text-xs"></i>
                                <span class="font-bold text-gray-700">{{ plan.to }}</span>
                            </div>
                            <div class="text-blue-600 font-bold">¬•{{ Math.round(plan.amount).toLocaleString() }}</div>
                        </div>
                        <p class="text-[10px] text-gray-400 text-center mt-2">*Ë®àÁÆóÂåØÁéá: {{settings.rate}}</p>
                    </div>
                </div>

                <div class="flex items-center gap-2 mb-4 overflow-x-auto hide-scrollbar pb-1">
                    <div v-for="member in members" :key="member" class="flex-shrink-0 bg-white border border-gray-200 px-3 py-1.5 rounded-full text-xs font-bold text-gray-600 shadow-sm">{{ member }}</div>
                    <button @click="addMember" class="flex-shrink-0 bg-gray-100 text-gray-400 px-3 py-1.5 rounded-full text-xs font-bold hover:bg-gray-200">+ ‰∫∫Âì°</button>
                </div>

                <div class="space-y-3">
                    <div v-for="(expense, idx) in expenses" :key="idx" class="bg-white rounded-xl p-3 shadow-sm border border-gray-100">
                        <div class="flex justify-between items-start">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full flex items-center justify-center text-white text-sm" :class="getCategoryColor(expense.category)">
                                    <i :class="getCategoryIcon(expense.category)"></i>
                                </div>
                                <div>
                                    <div class="font-bold text-gray-800">{{ expense.name }}</div>
                                    <div class="text-[10px] text-gray-400 mt-0.5">
                                        <span class="bg-gray-100 px-1.5 py-0.5 rounded text-gray-500 mr-1">{{ expense.payer }} ‰ªòÊ¨æ</span>
                                        <span v-if="expense.involved.length < members.length">({{ expense.involved.join(', ') }})</span>
                                        <span v-else>(ÂÖ®Âì°)</span>
                                    </div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-gray-700">¬•{{ expense.amount }}</div>
                                <div class="text-[10px] text-gray-400">{{ expense.date }}</div>
                            </div>
                        </div>
                    </div>
                </div>
                <button @click="openAddModal('expense')" class="fixed bottom-6 right-6 w-14 h-14 bg-yellow-500 text-white rounded-full shadow-xl flex items-center justify-center text-2xl z-40 hover:scale-110 transition"><i class="fas fa-plus"></i></button>
            </div>

        </div>

        <div v-if="showModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-fade-in">
            <div class="bg-white w-full max-w-sm rounded-2xl p-5 shadow-2xl transform transition-all scale-100 max-h-[90vh] overflow-y-auto">
                <h3 class="text-lg font-bold mb-4">{{ modalTitle }}</h3>
                
                <div v-if="modalType === 'schedule'" class="space-y-3">
                    <select v-model="editForm.category" class="w-full p-2 border rounded-lg bg-gray-50">
                        <option value="spot">ÊôØÈªû</option><option value="food">ÁæéÈ£ü</option><option value="shop">Ë≥ºÁâ©</option><option value="hotel">‰ΩèÂÆø</option><option value="flight">Ëà™Áè≠</option>
                    </select>
                    <input v-model="editForm.name" placeholder="ÂêçÁ®±" class="w-full p-2 border rounded-lg">
                    <div class="flex gap-2"><input v-model="editForm.startTime" type="time" class="w-1/2 p-2 border rounded-lg"><input v-model="editForm.endTime" type="time" class="w-1/2 p-2 border rounded-lg"></div>
                    <div class="bg-gray-50 p-2 rounded-lg">
                        <label class="text-xs text-gray-500">‰∫§ÈÄöÊñπÂºè (Âà∞‰∏ã‰∏ÄÁ´ô)</label>
                        <div class="flex gap-2 mt-1">
                            <select v-model="editForm.transportType" class="p-1 text-sm border rounded">
                                <option value="walk">Ê≠•Ë°å</option>
                                <option value="subway">Âú∞Èêµ</option>
                                <option value="train">ÁÅ´Ëªä</option>
                                <option value="hsr">È´òÈêµ</option>
                                <option value="tram">Ë∑ØÈù¢ÈõªËªä</option>
                                <option value="taxi">Ë®àÁ®ãËªä</option>
                                <option value="bus">ÂÆ¢ÈÅã/ÂÖ¨Ëªä</option>
                            </select>
                            <input v-model="editForm.transportTime" placeholder="ÊôÇÈñì (‰æã: 15ÂàÜ)" class="flex-1 p-1 text-sm border rounded">
                        </div>
                    </div>
                    <textarea v-model="editForm.notes" placeholder="ÂÇôË®ª" class="w-full p-2 border rounded-lg h-20"></textarea>
                </div>

                <div v-if="modalType === 'shopping'" class="space-y-3">
                    <input v-model="shoppingForm.name" placeholder="ÂïÜÂìÅÂêçÁ®±" class="w-full p-2 border rounded-lg">
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer relative"><input type="file" @change="handleImageUpload" class="absolute inset-0 opacity-0"><span class="text-gray-400 text-sm"><i class="fas fa-camera mr-1"></i> ‰∏äÂÇ≥ÂúñÁâá</span></div>
                </div>

                <div v-if="modalType === 'expense'" class="space-y-3">
                    <input v-model="expenseForm.name" placeholder="È†ÖÁõÆÂêçÁ®± (‰æãÂ¶Ç: ÊôöÈ§ê)" class="w-full p-2 border rounded-lg">
                    <div class="flex gap-2">
                        <input v-model="expenseForm.amount" type="number" placeholder="ÈáëÈ°ç (Êó•Âπ£)" class="w-2/3 p-2 border rounded-lg text-lg font-bold">
                        <select v-model="expenseForm.category" class="w-1/3 p-2 border rounded-lg bg-gray-50 text-sm"><option value="food">È£≤È£ü</option><option value="transport">‰∫§ÈÄö</option><option value="shop">Ë≥ºÁâ©</option><option value="ticket">ÈñÄÁ•®</option><option value="hotel">‰ΩèÂÆø</option><option value="other">ÂÖ∂‰ªñ</option></select>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <label class="text-xs text-gray-500 font-bold block mb-2">Ë™∞ÂÖà‰ªòÈå¢?</label>
                        <div class="flex flex-wrap gap-2">
                            <button v-for="m in members" :key="m" @click="expenseForm.payer = m" class="px-3 py-1 rounded-full text-xs transition border" :class="expenseForm.payer === m ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-600 border-gray-200'">{{ m }}</button>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <div class="flex justify-between mb-2"><label class="text-xs text-gray-500 font-bold">ÂàÜÊî§Áµ¶Ë™∞?</label><button @click="toggleAllInvolved" class="text-[10px] text-blue-500 font-bold">ÂÖ®ÈÅ∏/ÂÖ®‰∏çÈÅ∏</button></div>
                        <div class="flex flex-wrap gap-2">
                            <label v-for="m in members" :key="m" class="flex items-center gap-1 bg-white px-2 py-1 rounded border border-gray-200 text-xs"><input type="checkbox" :value="m" v-model="expenseForm.involved" class="rounded text-blue-600">{{ m }}</label>
                        </div>
                    </div>
                </div>

                <div class="flex gap-3 mt-6">
                    <button v-if="isEditing" @click="confirmDelete" class="flex-1 bg-red-100 text-red-500 py-2 rounded-lg font-bold">Âà™Èô§</button>
                    <button @click="showModal = false" class="flex-1 bg-gray-100 text-gray-500 py-2 rounded-lg font-bold">ÂèñÊ∂à</button>
                    <button @click="saveData" class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-bold">ÂÑ≤Â≠ò</button>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    const { createApp, ref, computed, onMounted, watch, onUnmounted } = Vue;

    createApp({
        setup() {
            const currentTab = ref('schedule');
            const currentDayIndex = ref(0);
            const showModal = ref(false);
            const modalType = ref('');
            const isEditing = ref(false);
            const isDraggable = ref(false); 
            const converter = ref({ jpy: 1000 });
            const weather = ref(null);
            const bannerRef = ref(null);
            
            const settings = ref({ rate: 0.225 });
            const members = ref(['Êàë']);
            const showSettlement = ref(false);

            let sortableInstance = null;

            // --- Ë°åÁ®ãË≥áÊñôÊõ¥Êñ∞ (12Â§©, 2025/12/24 - 2026/01/04) ---
            const schedule = ref([
                { date: "2025-12-24", location: "Tokyo", events: [
                    { id: 1, category: 'flight', name: 'Âè∞Âåó(TSA) ‚úàÔ∏è Êù±‰∫¨(HND)', startTime: '13:30', endTime: '17:30', depCode: 'TSA', arrCode: 'HND', duration: '3h', transportType: 'train', transportTime: '45ÂàÜ' },
                    { id: 2, category: 'hotel', name: 'Êù±‰∫¨‰ΩèÂÆø Check-in', startTime: '19:00', endTime: '', notes: 'Á¨¨‰∏ÄÊôöÊù±‰∫¨', transportType: 'walk', transportTime: '10ÂàÜ' }
                ]},
                { date: "2025-12-25", location: "Tokyo", events: [] },
                { date: "2025-12-26", location: "Tokyo", events: [] },
                { date: "2025-12-27", location: "Tokyo/Sapporo", events: [
                    { id: 10, category: 'flight', name: 'Êù±‰∫¨(HND) ‚úàÔ∏è Êú≠Âπå(CTS)', startTime: '18:00', endTime: '19:35', depCode: 'HND', arrCode: 'CTS', duration: '1h 35m', transportType: 'train', transportTime: '40ÂàÜ' },
                    { id: 11, category: 'hotel', name: 'Êú≠Âπå‰ΩèÂÆø Check-in', startTime: '21:00', endTime: '', notes: 'ÊäµÈÅîÂåóÊµ∑ÈÅì', transportType: 'walk', transportTime: '-' }
                ]},
                { date: "2025-12-28", location: "Sapporo", events: [] },
                { date: "2025-12-29", location: "Sapporo", events: [] },
                { date: "2025-12-30", location: "Sapporo", events: [] },
                { date: "2025-12-31", location: "Hakodate", events: [
                    { id: 20, category: 'transport', name: 'Êú≠Âπå üöÑ ÂáΩÈ§® (JRÁâπÊÄ•)', startTime: '10:56', endTime: '14:41', notes: 'ÁßªÂãïÊó•', transportType: 'walk', transportTime: '20ÂàÜ' },
                    { id: 21, category: 'hotel', name: 'ÂáΩÈ§®‰ΩèÂÆø', startTime: '15:30', endTime: '', notes: 'Ë∑®Âπ¥Â§ú', transportType: 'walk', transportTime: '-' }
                ]},
                { date: "2026-01-01", location: "Hakodate", events: [] },
                { date: "2026-01-02", location: "Tokyo", events: [
                    { id: 30, category: 'flight', name: 'ÂáΩÈ§®(HKD) ‚úàÔ∏è Êù±‰∫¨(HND)', startTime: '11:45', endTime: '13:15', depCode: 'HKD', arrCode: 'HND', duration: '1h 30m', transportType: 'train', transportTime: '40ÂàÜ' },
                    { id: 31, category: 'hotel', name: 'Êù±‰∫¨‰ΩèÂÆø', startTime: '15:00', endTime: '', notes: 'ÂõûÂà∞Êù±‰∫¨', transportType: 'walk', transportTime: '-' }
                ]},
                { date: "2026-01-03", location: "Tokyo", events: [] },
                { date: "2026-01-04", location: "Tokyo", events: [
                    { id: 40, category: 'flight', name: 'Êù±‰∫¨(HND) ‚úàÔ∏è Âè∞Âåó(TSA)', startTime: '12:40', endTime: '15:50', depCode: 'HND', arrCode: 'TSA', duration: '4h 10m', transportType: 'walk', transportTime: '-' }
                ]}
            ]);

            const shoppingList = ref([]);
            const expenses = ref([]);

            const editForm = ref({});
            const shoppingForm = ref({});
            const expenseForm = ref({});

            // ---------------- ÂãïÊÖãÁ©çÈõ™ Canvas (ÁÑ°Èô∞ÂΩ±/ÈÄèÊòéÁâà) ----------------
            let canvas, ctx, animationId;
            const flakes = [];
            const snowPileHeight = new Array(480).fill(0);

            const initCanvas = () => {
                canvas = document.getElementById('snow-canvas');
                if (!canvas) return;
                const resize = () => {
                    canvas.width = canvas.parentElement.offsetWidth;
                    canvas.height = canvas.parentElement.offsetHeight;
                    if (snowPileHeight.length !== canvas.width) {
                       snowPileHeight.length = canvas.width;
                       for(let i=0; i<canvas.width; i++) snowPileHeight[i] = 0;
                    }
                };
                window.addEventListener('resize', resize);
                resize();
                for (let i = 0; i < 50; i++) {
                    // ÈÄüÂ∫¶ÊÖ¢‰∏ÄÈªû (d Â∞è‰∏ÄÈªû)
                    flakes.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, r: Math.random() * 2 + 1, d: Math.random() * 0.5 + 0.2 });
                }
                animateSnow();
            };

            const animateSnow = () => {
                if (!canvas) return;
                ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // 1. Áπ™Ë£ΩÁ©çÈõ™ (Á¥îÁôΩ, Â∏∂‰∏ÄÈªûÈªûÈÄèÊòéÂ∫¶ËÆìÂÆÉÊõ¥ËºïÁõà)
                ctx.fillStyle = "rgba(255, 255, 255, 0.95)";
                ctx.beginPath();
                ctx.moveTo(0, canvas.height);
                for (let i = 0; i < canvas.width; i++) {
                    let h = snowPileHeight[i];
                    // Âä†‰∏ä‰∏ÄÈªûÂ∫ïÈÉ®È†êË®≠È´òÂ∫¶ (Ëàá‰∏ãÊñπÊº∏Â±§ div ÈäúÊé•)
                    // ‰ΩÜÂõ†ÁÇ∫‰∏ãÊñπ div Â∑≤Á∂ìÊúâ #f8fafcÔºåÈÄôË£°ËÆìÁ©çÈõ™‰πüÊòØÁ¥îÁôΩ/Á¥îËÉåÊôØËâ≤
                    ctx.lineTo(i, canvas.height - h);
                }
                ctx.lineTo(canvas.width, canvas.height);
                ctx.fill();

                // 2. Áπ™Ë£ΩÈõ™Ëä±
                ctx.fillStyle = "rgba(255, 255, 255, 0.8)";
                ctx.beginPath();
                for (let i = 0; i < flakes.length; i++) {
                    const f = flakes[i];
                    ctx.moveTo(f.x, f.y);
                    ctx.arc(f.x, f.y, f.r, 0, Math.PI * 2, true);
                }
                ctx.fill();
                updateFlakes();
                animationId = requestAnimationFrame(animateSnow);
            };

            const updateFlakes = () => {
                for (let i = 0; i < flakes.length; i++) {
                    const f = flakes[i];
                    f.y += Math.pow(f.d, 2) * 0.5 + 0.3; // ÈÄüÂ∫¶ÊÖ¢
                    f.x += Math.sin(f.y * 0.05) * 0.3;
                    const floorIndex = Math.floor(f.x);
                    if (floorIndex >= 0 && floorIndex < canvas.width) {
                        const pileHeight = snowPileHeight[floorIndex];
                        if (f.y + f.r >= canvas.height - pileHeight) {
                            if (pileHeight < 25) { // Á©çÈõ™È´òÂ∫¶‰∏äÈôê
                                for(let k = -2; k <= 2; k++) {
                                    if (floorIndex + k >= 0 && floorIndex + k < canvas.width) {
                                        snowPileHeight[floorIndex + k] += 0.4 * (3 - Math.abs(k));
                                    }
                                }
                            }
                            resetFlake(f);
                        }
                    } else if (f.y > canvas.height) {
                        resetFlake(f);
                    }
                }
            };
            const resetFlake = (f) => { f.y = -10; f.x = Math.random() * canvas.width; };
            // ------------------------------------------------

            onMounted(() => {
                const savedData = localStorage.getItem('tripData');
                if (savedData) {
                    const parsed = JSON.parse(savedData);
                    // ÁÇ∫‰∫ÜÂº∑Âà∂Êõ¥Êñ∞Êó•ÊúüÔºåÈÄôË£°Ë®ªËß£Êéâ schedule ÁöÑËÆÄÂèñÔºåËã•ÊÇ®Â∏åÊúõ‰øùÁïôËàäË≥áÊñôË´ãËá™Ë°åÊñüÈÖå
                    // schedule.value = parsed.schedule || schedule.value; 
                    shoppingList.value = parsed.shoppingList || [];
                    expenses.value = parsed.expenses || [];
                    members.value = parsed.members || ['Êàë'];
                    settings.value = parsed.settings || { rate: 0.225 };
                }
                initSortable();
                fetchWeather();
                setTimeout(initCanvas, 100);
            });

            onUnmounted(() => { cancelAnimationFrame(animationId); });

            watch([schedule, shoppingList, expenses, members, settings], () => {
                localStorage.setItem('tripData', JSON.stringify({
                    schedule: schedule.value, shoppingList: shoppingList.value, expenses: expenses.value, members: members.value, settings: settings.value
                }));
            }, { deep: true });

            // Áõ£ËÅΩÊãñÊõ≥Ê®°ÂºèÈñãÈóú
            watch(isDraggable, (val) => {
                if (sortableInstance) {
                    sortableInstance.option("disabled", !val); 
                }
            });

            const toggleDraggable = () => {
                isDraggable.value = !isDraggable.value;
            };

            const settlementPlan = computed(() => {
                let balance = {}; members.value.forEach(m => balance[m] = 0);
                expenses.value.forEach(ex => {
                    const amount = parseFloat(ex.amount);
                    if (!amount || !ex.involved || ex.involved.length === 0) return;
                    balance[ex.payer] = (balance[ex.payer] || 0) + amount;
                    const share = amount / ex.involved.length;
                    ex.involved.forEach(p => { balance[p] = (balance[p] || 0) - share; });
                });
                let debtors = [], creditors = [];
                for (let p in balance) { if (balance[p] < -1) debtors.push({ name: p, amount: balance[p] }); else if (balance[p] > 1) creditors.push({ name: p, amount: balance[p] }); }
                debtors.sort((a, b) => a.amount - b.amount); creditors.sort((a, b) => b.amount - a.amount);
                let plan = []; let i = 0, j = 0;
                while (i < debtors.length && j < creditors.length) {
                    let debtor = debtors[i], creditor = creditors[j];
                    let amount = Math.min(Math.abs(debtor.amount), creditor.amount);
                    plan.push({ from: debtor.name, to: creditor.name, amount: amount });
                    debtor.amount += amount; creditor.amount -= amount;
                    if (Math.abs(debtor.amount) < 1) i++; if (creditor.amount < 1) j++;
                }
                return plan;
            });

            const toggleSettlement = () => showSettlement.value = !showSettlement.value;
            const addMember = () => { const name = prompt("Ëº∏ÂÖ•Êñ∞ÊàêÂì°ÂêçÂ≠ó:"); if (name && !members.value.includes(name)) members.value.push(name); };
            const toggleAllInvolved = () => { if (expenseForm.value.involved.length === members.value.length) expenseForm.value.involved = []; else expenseForm.value.involved = [...members.value]; };
            
            const initSortable = () => { 
                const el = document.getElementById('itinerary-list'); 
                if(el) { 
                    sortableInstance = new Sortable(el, { 
                        animation: 150, 
                        handle: '.itinerary-item', 
                        disabled: !isDraggable.value, 
                        onEnd: function (evt) { 
                            const item = schedule.value[currentDayIndex.value].events.splice(evt.oldIndex, 1)[0]; 
                            schedule.value[currentDayIndex.value].events.splice(evt.newIndex, 0, item); 
                        } 
                    }); 
                } 
            };
            
            watch(currentDayIndex, () => { setTimeout(initSortable, 100); fetchWeather(); });
            const fetchWeather = async () => { weather.value = { temp: -2, feelsLike: -5, code: 71, desc: 'ÈôçÈõ™' }; };
            
            const getDayName = (d) => new Date(d).toLocaleDateString('en-US', { weekday: 'short' });
            const getDayNum = (d) => new Date(d).getDate();
            const getCategoryIcon = (c) => ({ flight: 'fa-plane', hotel: 'fa-bed', spot: 'fa-camera', food: 'fa-utensils', shop: 'fa-bag-shopping', transport: 'fa-train', ticket: 'fa-ticket', other: 'fa-star' }[c] || 'fa-circle');
            const getCategoryColor = (c) => ({ flight: 'bg-blue-400', hotel: 'bg-indigo-400', spot: 'bg-pink-400', food: 'bg-orange-400', shop: 'bg-yellow-400', transport: 'bg-green-400' }[c] || 'bg-gray-400');
            
            // --- Êñ∞Â¢ûÁöÑ‰∫§ÈÄöÂúñÁ§∫ÈÇèËºØ ---
            const getTransportIcon = (type) => {
                switch(type) {
                    case 'walk': return 'fas fa-person-walking';
                    case 'subway': return 'fas fa-train-subway';
                    case 'train': return 'fas fa-train';
                    case 'hsr': return 'fas fa-train'; // È´òÈêµ (Â≠óÂ∫´ÁÑ° HSR Â∞àÁî®ÔºåÊö´Áî®ÁÅ´Ëªä)
                    case 'tram': return 'fas fa-train-tram';
                    case 'taxi': return 'fas fa-taxi';
                    case 'bus': return 'fas fa-bus';
                    default: return 'fas fa-person-walking';
                }
            };

            const getWeatherIcon = () => 'fas fa-snowflake';
            const getMapLink = (n) => `https://www.google.com/maps/search/?api=1&query=$${encodeURIComponent(n)}`;
            const totalExpenses = computed(() => expenses.value.reduce((sum, item) => sum + Number(item.amount), 0));
            const modalTitle = computed(() => ({ schedule: isEditing.value?'Á∑®ËºØË°åÁ®ã':'Êñ∞Â¢ûË°åÁ®ã', shopping:'Êñ∞Â¢ûË≥ºÁâ©Ê∏ÖÂñÆ', expense:'Êñ∞Â¢ûËä±Ë≤ª' }[modalType.value] || ''));

            const openAddModal = (type) => {
                modalType.value = type; isEditing.value = false;
                editForm.value = { category: 'spot', transportType: 'train', transportTime: '20ÂàÜ' };
                shoppingForm.value = {};
                expenseForm.value = { category: 'food', payment: 'ÁèæÈáë', date: schedule.value[currentDayIndex.value].date, payer: 'Êàë', involved: [...members.value] };
                showModal.value = true;
            };
            const editEvent = (item) => { 
                if(isDraggable.value) return; 
                if(item.category==='flight')return; 
                modalType.value='schedule'; isEditing.value=true; editForm.value=JSON.parse(JSON.stringify(item)); showModal.value=true; 
            };
            const handleImageUpload = (e) => { const f=e.target.files[0]; if(f){ const r=new FileReader(); r.onload=(e)=>shoppingForm.value.image=e.target.result; r.readAsDataURL(f); } };
            const saveData = () => {
                if(modalType.value==='schedule') { if(isEditing.value){ const idx=schedule.value[currentDayIndex.value].events.findIndex(e=>e.id===editForm.value.id); if(idx!==-1) schedule.value[currentDayIndex.value].events[idx]=editForm.value; } else { editForm.value.id=Date.now(); schedule.value[currentDayIndex.value].events.push(editForm.value); } }
                else if(modalType.value==='shopping') shoppingList.value.push(shoppingForm.value);
                else if(modalType.value==='expense') expenses.value.push(expenseForm.value);
                showModal.value = false;
            };
            const confirmDelete = () => { if(confirm("Âà™Èô§?")){ const idx=schedule.value[currentDayIndex.value].events.findIndex(e=>e.id===editForm.value.id); if(idx!==-1)schedule.value[currentDayIndex.value].events.splice(idx,1); showModal.value=false; } };
            const deleteShoppingItem = (i) => { if(confirm("Âà™Èô§?")) shoppingList.value.splice(i,1); };

            return {
                currentTab, currentDayIndex, schedule, showModal, modalType, isEditing, modalTitle,
                editForm, shoppingForm, expenseForm, shoppingList, expenses, converter, weather, settings, members,
                totalExpenses, bannerRef, showSettlement, settlementPlan, toggleSettlement, addMember, toggleAllInvolved,
                openAddModal, editEvent, saveData, confirmDelete, deleteShoppingItem, handleImageUpload,
                getDayName, getDayNum, getCategoryIcon, getCategoryColor, getTransportIcon, getWeatherIcon, getMapLink,
                isDraggable, toggleDraggable
            };
        }
    }).mount('#app');
</script>

</body>
</html>
