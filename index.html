<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Japan Winter Trip 2025-26</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Zen Maru Gothic', sans-serif; background-color: #f8fafc; color: #334155; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .app-container { max-width: 480px; margin: 0 auto; min-height: 100vh; background-color: #f8fafc; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.05); padding-bottom: 80px; overflow-x: hidden; }
        .content-area { position: relative; z-index: 10; background-color: #f8fafc; padding-top: 0.5rem; min-height: 500px; }
        
        .glass-btn { width: 40px; height: 40px; border-radius: 50%; background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(4px); border: 1px solid rgba(255, 255, 255, 0.4); color: rgba(255, 255, 255, 0.95); display: flex; align-items: center; justify-content: center; font-size: 1.1rem; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer; }
        .glass-btn:active { transform: scale(0.95); background: rgba(255, 255, 255, 0.4); }
        .glass-btn.active { background: #ffffff; color: #3B82F6; border-color: #ffffff; transform: scale(1.05); box-shadow: 0 4px 8px rgba(0,0,0,0.1); opacity: 1; }
        .glass-btn.edit-active { background: #ffffff; color: #F59E0B; border-color: #ffffff; transform: scale(1.1); box-shadow: 0 4px 10px rgba(0,0,0,0.15); opacity: 1; }

        #snow-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; }
        .boarding-pass { background: linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%); border: 1px solid #cbd5e1; position: relative; overflow: hidden; }
        .boarding-pass::before, .boarding-pass::after { content: ''; position: absolute; top: 50%; width: 20px; height: 20px; background-color: #f8fafc; border-radius: 50%; border: 1px solid #cbd5e1; transform: translateY(-50%); }
        .boarding-pass::before { left: -11px; transform: translateY(-50%) rotate(45deg); }
        .boarding-pass::after { right: -11px; transform: translateY(-50%) rotate(-45deg); }
        
        @keyframes shake { 0% { transform: rotate(0deg); } 25% { transform: rotate(0.5deg); } 50% { transform: rotate(0deg); } 75% { transform: rotate(-0.5deg); } 100% { transform: rotate(0deg); } }
        .draggable-shake { animation: shake 0.3s infinite ease-in-out; cursor: move; }
    </style>
</head>
<body>

<div id="app" v-cloak>
    <div class="app-container">
        
        <div class="relative h-[230px] w-full overflow-hidden" ref="bannerRef">
            <img src="banner.jpg" alt="Banner" class="w-full h-full object-cover object-center">
            <canvas id="snow-canvas"></canvas>

            <div class="absolute bottom-[8px] left-[15px] right-[15px] flex justify-between items-end z-20 pointer-events-none">
                <div class="flex gap-2 pointer-events-auto">
                    <button @click="toggleDraggable" class="glass-btn" :class="{ 'edit-active': isDraggable }"><i class="fas fa-pencil-alt"></i></button>
                    <button v-if="['schedule', 'shopping', 'expenses'].includes(currentTab)" @click="handleAddClick" class="glass-btn"><i class="fas fa-plus"></i></button>
                </div>
                <div class="flex gap-2 pointer-events-auto">
                    <button @click="currentTab = 'checklist'" :class="['glass-btn', currentTab === 'checklist' ? 'active' : '']"><i class="fas fa-clipboard-check"></i></button>
                    <button @click="currentTab = 'schedule'" :class="['glass-btn', currentTab === 'schedule' ? 'active' : '']"><i class="fas fa-map-location-dot"></i></button>
                    <button @click="currentTab = 'info'" :class="['glass-btn', currentTab === 'info' ? 'active' : '']"><i class="fas fa-circle-info"></i></button>
                    <button @click="currentTab = 'shopping'" :class="['glass-btn', currentTab === 'shopping' ? 'active' : '']"><i class="fas fa-basket-shopping"></i></button>
                    <button @click="currentTab = 'expenses'" :class="['glass-btn', currentTab === 'expenses' ? 'active' : '']"><i class="fas fa-yen-sign"></i></button>
                </div>
            </div>
        </div>

        <div class="content-area px-5">

            <div v-show="currentTab === 'checklist'" class="pb-20">
                <div class="flex items-center gap-2 mb-4 overflow-x-auto hide-scrollbar pb-1">
                    <div v-for="member in members" :key="member" @click="currentChecklistMember = member" class="flex-shrink-0 border px-4 py-1.5 rounded-full text-xs font-bold shadow-sm cursor-pointer transition-colors" :class="currentChecklistMember === member ? 'bg-blue-600 text-white border-blue-600' : 'bg-white border-gray-200 text-gray-500 hover:bg-gray-50'">{{ member }}</div>
                </div>
                <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 mb-4 sticky top-0 z-10">
                    <div class="flex justify-between items-end mb-2">
                        <h3 class="font-bold text-gray-800 text-lg">è¡Œææ¸…å–®</h3>
                        <span class="text-xs font-bold" :class="packingProgress > 60 ? 'text-green-500' : 'text-blue-500'">{{ packingProgress > 60 ? 'Ready to Go! 100%' : 'æº–å‚™é€²åº¦ ' + packingProgress + '%' }}</span>
                    </div>
                    <div class="w-full bg-gray-100 rounded-full h-2.5 overflow-hidden">
                        <div class="h-2.5 rounded-full transition-all duration-500" :class="packingProgress > 60 ? 'bg-gradient-to-r from-green-400 to-emerald-500' : 'bg-gradient-to-r from-blue-400 to-indigo-500'" :style="{ width: (packingProgress > 60 ? 100 : packingProgress) + '%' }"></div>
                    </div>
                </div>
                <div class="space-y-4">
                    <div v-if="currentChecklistData" v-for="(category, cIdx) in currentChecklistData" :key="cIdx" class="bg-white rounded-xl overflow-hidden shadow-sm border border-gray-100">
                        <div class="bg-gray-50 px-4 py-2 border-b border-gray-100 flex justify-between items-center"><span class="font-bold text-gray-700 text-sm">{{ category.name }}</span><span class="text-[10px] text-gray-400">{{ category.items.filter(i => i.checked).length }}/{{ category.items.length }}</span></div>
                        <div class="p-2">
                            <div v-for="(item, iIdx) in category.items" :key="iIdx" class="flex items-center justify-between p-2 rounded hover:bg-gray-50 transition cursor-pointer" @click="toggleCheckItem(item)">
                                <div class="flex items-center gap-3"><div class="w-5 h-5 rounded border flex items-center justify-center transition-colors" :class="item.checked ? 'bg-green-500 border-green-500 text-white' : 'border-gray-300 text-transparent'"><i class="fas fa-check text-xs"></i></div><span class="text-sm text-gray-700" :class="{ 'line-through text-gray-400': item.checked }">{{ item.name }}</span></div>
                                <div class="flex gap-1"><span v-if="item.important" class="text-[10px] bg-yellow-100 text-yellow-700 px-1.5 py-0.5 rounded font-bold"><i class="fas fa-star mr-0.5"></i>é‡è¦å¿…å¸¶</span><span v-if="item.tag" class="text-[10px] px-1.5 py-0.5 rounded font-bold" :class="item.tag === 'éš¨èº«' ? 'bg-orange-100 text-orange-600' : 'bg-blue-100 text-blue-600'">{{ item.tag }}</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-show="currentTab === 'schedule'">
                <div class="flex space-x-3 overflow-x-auto hide-scrollbar mb-4 pb-2">
                    <button v-for="(day, index) in schedule" :key="index" @click="currentDayIndex = index" class="flex-shrink-0 flex flex-col items-center justify-center w-14 h-16 rounded-xl transition-all border" :class="currentDayIndex === index ? 'bg-blue-600 text-white shadow-lg scale-105 border-blue-600' : 'bg-white text-gray-400 border-gray-100'">
                        <span class="text-xs uppercase font-bold">{{ getDayName(day.date) }}</span><span class="text-lg font-bold">{{ getDayNum(day.date) }}</span>
                    </button>
                </div>
                <div v-if="weather" class="mb-6 bg-blue-50/80 rounded-xl p-3 flex items-center justify-between border border-blue-100 shadow-sm">
                    <div class="flex items-center gap-3"><div class="text-3xl" :class="weather.iconClass"><i :class="weather.icon"></i></div><div><div class="text-sm font-bold text-gray-700">{{ schedule[currentDayIndex].location.split('/')[0] }}</div><div class="text-xs text-gray-500">{{ weather.desc }}</div></div></div>
                    <div class="text-right"><div class="text-2xl font-bold text-gray-800">{{ weather.temp }}Â°</div><div class="text-xs text-gray-400">é«”æ„Ÿ {{ weather.feelsLike }}Â°</div><div v-if="weather.uv !== undefined" class="text-[10px] font-bold mt-0.5" :class="getUVColor(weather.uv)"><i class="fas fa-sun mr-0.5"></i>UV: {{ weather.uv }}</div></div>
                </div>
                <div id="itinerary-list" class="space-y-0 relative pb-20">
                    <div v-for="(item, idx) in schedule[currentDayIndex].events" :key="item.id" class="relative group itinerary-item pb-6" :data-id="item.id">
                        <div v-if="idx < schedule[currentDayIndex].events.length - 1" class="absolute left-[19px] top-10 bottom-0 w-[2px] bg-gray-200 z-0 flex flex-col items-center justify-center"><div class="bg-gray-100 text-[10px] text-gray-500 px-1 py-0.5 rounded border border-gray-200 mt-4 whitespace-nowrap z-10 flex items-center gap-1"><i :class="getTransportIcon(item.transportType)"></i> {{ item.transportTime }}</div></div>
                        <div v-if="item.category === 'flight' && idx === 0" class="pl-0 mb-4">
                            <div class="boarding-pass rounded-2xl p-4 shadow-sm relative">
                                <div class="flex justify-between items-center mb-3 border-b border-dashed border-gray-300 pb-2"><div class="text-blue-800 font-bold tracking-widest"><i class="fas fa-plane-departure mr-1"></i> ANA</div><div class="text-gray-400 text-xs">{{ item.date }}</div></div>
                                <div class="flex justify-between items-center"><div class="text-center"><div class="text-3xl font-bold text-gray-800">{{ item.depCode }}</div><div class="text-xs text-gray-500">{{ item.startTime }}</div></div><div class="flex-1 flex flex-col items-center px-2"><i class="fas fa-plane text-blue-300 transform" :class="item.date.includes('24') || item.date.includes('27') ? '' : ''"></i><div class="text-[10px] text-gray-400 mt-1">{{ item.duration || 'é£›è¡Œä¸­' }}</div></div><div class="text-center"><div class="text-3xl font-bold text-gray-800">{{ item.arrCode }}</div><div class="text-xs text-gray-500">{{ item.endTime }}</div></div></div>
                                <div class="mt-3 text-center text-sm font-medium text-gray-600 bg-gray-50 py-1 rounded">{{ item.name }}</div>
                            </div>
                        </div>
                        <div v-else class="relative pl-12 cursor-pointer" @click="editEvent(item)" :class="{ 'opacity-90': isDraggable }">
                            <div v-if="isDraggable" class="absolute right-2 top-2 text-gray-300 z-20"><i class="fas fa-bars"></i></div>
                            <div class="absolute left-0 top-0 w-10 h-10 rounded-full flex items-center justify-center text-white shadow-md z-10 border-2 border-white" :class="[getCategoryColor(item.category), isDraggable ? 'draggable-shake' : '']"><i :class="getCategoryIcon(item.category)"></i></div>
                            <div class="bg-white rounded-xl p-3 shadow-sm border border-gray-100 hover:shadow-md transition active:scale-95">
                                <div class="flex justify-between items-start"><h3 class="font-bold text-gray-800 text-lg">{{ item.name }}</h3><a v-if="!isDraggable" :href="getMapLink(item.name)" @click.stop target="_blank" class="text-blue-500 bg-blue-50 w-8 h-8 rounded-full flex items-center justify-center"><i class="fas fa-location-arrow"></i></a></div>
                                <div class="mt-1 flex flex-wrap gap-2 text-xs text-gray-500"><span v-if="item.startTime" class="bg-gray-100 px-2 py-1 rounded"><i class="far fa-clock mr-1"></i>{{ item.startTime }}~{{item.endTime}}</span><span v-if="item.category === 'spot' && item.cost" class="bg-yellow-50 text-yellow-600 px-2 py-1 rounded"><i class="fas fa-ticket-alt mr-1"></i>{{ item.cost }}</span></div>
                                <p v-if="item.notes" class="mt-2 text-sm text-gray-500 border-l-2 border-gray-200 pl-2 line-clamp-2">{{ item.notes }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-show="currentTab === 'info'" class="space-y-6 pb-20">
                <div class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100">
                    <h3 class="font-bold text-gray-800 mb-3 flex justify-between items-center"><span><i class="fas fa-coins text-yellow-500 mr-2"></i>åŒ¯ç‡æ›ç®— (JPY/TWD)</span><span class="text-[10px] text-gray-400 font-normal bg-gray-50 px-2 py-1 rounded"><span v-if="settings.lastUpdate">æ›´æ–°: {{ settings.lastUpdate }}</span><span v-else>æ›´æ–°ä¸­...</span></span></h3>
                    <div class="flex items-center gap-3"><div class="flex-1"><label class="text-xs text-gray-400 block mb-1">æ—¥å¹£ (JPY)</label><input type="number" v-model="converter.jpy" @input="calculateTWD" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-lg font-bold text-blue-600" placeholder="0"></div><i class="fas fa-exchange-alt text-gray-300 mt-4"></i><div class="flex-1"><label class="text-xs text-gray-400 block mb-1">å°å¹£ (TWD)</label><input type="number" v-model="converter.twd" @input="calculateJPY" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-lg font-bold text-green-600" placeholder="0"></div></div>
                    <div class="text-[10px] text-right mt-2 text-gray-400">ç•¶å‰åŒ¯ç‡: {{ settings.rate }}</div>
                </div>
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="bg-blue-600 px-4 py-2 text-white text-sm font-bold flex justify-between items-center"><span><i class="fas fa-plane mr-2"></i>èˆªç­è³‡è¨Š (ANA)</span></div>
                    <div class="p-4 border-b border-gray-100 relative group"><div class="flex justify-between mb-2"><span class="text-xs bg-blue-100 text-blue-600 px-2 py-0.5 rounded font-bold">èˆªç­ 1</span><span class="text-xs text-gray-500">12/24</span></div><div class="flex justify-between items-center text-center"><div><div class="text-2xl font-black text-gray-800">TSA</div><div class="text-xs text-gray-500">13:30</div><div class="text-[10px] text-gray-400 mt-1">æ¾å±± T1</div></div><div class="flex-1 px-2 flex flex-col items-center"><div class="text-[10px] text-blue-500 font-bold mb-1">3h</div><div class="w-full h-[1px] bg-gray-300 relative"><i class="fas fa-plane absolute top-1/2 left-1/2 transform -translate-y-1/2 -translate-x-1/2 text-gray-400 text-xs"></i></div><div class="text-[10px] text-gray-400 mt-1">NH852</div></div><div><div class="text-2xl font-black text-gray-800">HND</div><div class="text-xs text-gray-500">17:30</div><div class="text-[10px] text-gray-400 mt-1">ç¾½ç”° T2</div></div></div></div>
                    <div class="p-4 border-b border-gray-100 relative group"><div class="flex justify-between mb-2"><span class="text-xs bg-blue-100 text-blue-600 px-2 py-0.5 rounded font-bold">èˆªç­ 2</span><span class="text-xs text-gray-500">12/27</span></div><div class="flex justify-between items-center text-center"><div><div class="text-2xl font-black text-gray-800">HND</div><div class="text-xs text-gray-500">18:00</div><div class="text-[10px] text-gray-400 mt-1">ç¾½ç”° T2</div></div><div class="flex-1 px-2 flex flex-col items-center"><div class="text-[10px] text-blue-500 font-bold mb-1">1h 35m</div><div class="w-full h-[1px] bg-gray-300 relative"><i class="fas fa-plane absolute top-1/2 left-1/2 transform -translate-y-1/2 -translate-x-1/2 text-gray-400 text-xs"></i></div><div class="text-[10px] text-gray-400 mt-1">NH75</div></div><div><div class="text-2xl font-black text-gray-800">CTS</div><div class="text-xs text-gray-500">19:35</div><div class="text-[10px] text-gray-400 mt-1">æ–°åƒæ­²</div></div></div></div>
                    <div class="p-4 border-b border-gray-100 relative group"><div class="flex justify-between mb-2"><span class="text-xs bg-blue-100 text-blue-600 px-2 py-0.5 rounded font-bold">èˆªç­ 3</span><span class="text-xs text-gray-500">01/02</span></div><div class="flex justify-between items-center text-center"><div><div class="text-2xl font-black text-gray-800">HKD</div><div class="text-xs text-gray-500">11:45</div><div class="text-[10px] text-gray-400 mt-1">å‡½é¤¨</div></div><div class="flex-1 px-2 flex flex-col items-center"><div class="text-[10px] text-blue-500 font-bold mb-1">1h 30m</div><div class="w-full h-[1px] bg-gray-300 relative"><i class="fas fa-plane absolute top-1/2 left-1/2 transform -translate-y-1/2 -translate-x-1/2 text-gray-400 text-xs"></i></div><div class="text-[10px] text-gray-400 mt-1">NH554</div></div><div><div class="text-2xl font-black text-gray-800">HND</div><div class="text-xs text-gray-500">13:15</div><div class="text-[10px] text-gray-400 mt-1">ç¾½ç”° T2</div></div></div></div>
                    <div class="p-4 relative group"><div class="flex justify-between mb-2"><span class="text-xs bg-blue-100 text-blue-600 px-2 py-0.5 rounded font-bold">èˆªç­ 4</span><span class="text-xs text-gray-500">01/04</span></div><div class="flex justify-between items-center text-center"><div><div class="text-2xl font-black text-gray-800">HND</div><div class="text-xs text-gray-500">12:40</div><div class="text-[10px] text-gray-400 mt-1">ç¾½ç”° T2</div></div><div class="flex-1 px-2 flex flex-col items-center"><div class="text-[10px] text-blue-500 font-bold mb-1">4h 10m</div><div class="w-full h-[1px] bg-gray-300 relative"><i class="fas fa-plane absolute top-1/2 left-1/2 transform -translate-y-1/2 -translate-x-1/2 text-gray-400 text-xs"></i></div><div class="text-[10px] text-gray-400 mt-1">NH853</div></div><div><div class="text-2xl font-black text-gray-800">TSA</div><div class="text-xs text-gray-500">15:50</div><div class="text-[10px] text-gray-400 mt-1">æ¾å±± T1</div></div></div></div>
                </div>
                <div class="grid grid-cols-1 gap-3"><div v-for="(hotel, idx) in hotels" :key="idx" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col"><div class="flex items-start justify-between"><div><h4 class="font-bold text-gray-800 text-lg">{{ hotel.name }}</h4><span class="inline-block bg-indigo-50 text-indigo-600 text-[10px] px-2 py-0.5 rounded mt-1 font-bold">{{ hotel.dates }}</span></div><div class="w-8 h-8 bg-indigo-100 text-indigo-600 rounded-lg flex items-center justify-center shrink-0"><i class="fas fa-hotel"></i></div></div><div class="mt-3 space-y-1 text-sm text-gray-500"><p><i class="fas fa-map-marker-alt w-4 text-center mr-1"></i>{{ hotel.address }}</p><p><i class="fas fa-phone w-4 text-center mr-1"></i>{{ hotel.phone }}</p></div><a :href="hotel.mapLink" target="_blank" class="mt-3 bg-indigo-50 text-indigo-600 py-2 rounded-lg text-xs font-bold text-center hover:bg-indigo-100 transition"><i class="fas fa-location-arrow mr-1"></i> é–‹å•Ÿå°èˆª</a></div></div>
                <div class="grid grid-cols-2 gap-3 mt-6"><div class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex items-center gap-3"><div class="w-10 h-10 bg-red-100 text-red-500 rounded-full flex items-center justify-center font-bold text-lg">119</div><div><div class="font-bold text-gray-800">æ•‘è­·è»Š/ç«è­¦</div><div class="text-xs text-gray-400">æ—¥æœ¬å…¨å¢ƒ</div></div></div><div class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex items-center gap-3"><div class="w-10 h-10 bg-blue-100 text-blue-500 rounded-full flex items-center justify-center font-bold text-lg">110</div><div><div class="font-bold text-gray-800">è­¦å¯Ÿå±€</div><div class="text-xs text-gray-400">æ—¥æœ¬å…¨å¢ƒ</div></div></div><div class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 col-span-2"><div class="font-bold text-gray-800 text-sm mb-1">å°åŒ—é§æ—¥ä»£è¡¨è™• (æ±äº¬)</div><div class="text-xs text-gray-500">ç·Šæ€¥é›»è©±: +81-3-3280-7917</div><div class="text-xs text-gray-500">åœ°å€: æ±äº¬éƒ½æ¸¯å€ç™½é‡‘å°5-20-2</div></div></div>
                
                <div class="text-center pb-8 mt-12 opacity-50 hover:opacity-100 transition"><button @click="resetAllData" class="text-[10px] text-red-300 border border-red-100 px-3 py-1 rounded-full hover:bg-red-50 hover:text-red-500 transition">âš ï¸ å¦‚æœç•«é¢ç•°å¸¸è«‹é»æˆ‘é‡ç½®</button></div>
            </div>

            <div v-show="currentTab === 'shopping'" class="pb-20">
                <h3 class="font-bold text-xl text-gray-800 mb-4">è³¼ç‰©æ¸…å–® <span class="text-sm font-normal text-gray-400">({{ shoppingList.length }})</span></h3>
                <div class="grid grid-cols-2 gap-3">
                    <div v-for="(item, idx) in shoppingList" :key="idx" class="bg-white rounded-xl overflow-hidden shadow-sm border border-gray-100 relative group">
                        <button @click="deleteShoppingItem(idx)" class="absolute top-2 right-2 bg-red-500 text-white w-6 h-6 rounded-full text-xs flex items-center justify-center opacity-0 group-hover:opacity-100 transition z-10"><i class="fas fa-times"></i></button>
                        <div class="h-32 bg-gray-100 relative"><img v-if="item.image" :src="item.image" class="w-full h-full object-cover"><div v-else class="absolute inset-0 flex items-center justify-center text-gray-300"><i class="fas fa-image text-2xl"></i></div></div>
                        <div class="p-3"><div class="font-bold text-gray-700 truncate">{{ item.name }}</div><div class="flex items-center gap-1 text-xs text-gray-400 mt-1"><input type="checkbox" v-model="item.checked" class="rounded text-blue-500"><span>å·²è³¼è²·</span></div></div>
                    </div>
                </div>
            </div>

            <div v-show="currentTab === 'expenses'" class="pb-20">
                <div class="bg-gradient-to-r from-slate-700 to-slate-800 rounded-2xl p-5 text-white shadow-lg mb-6">
                    <div class="flex justify-between items-start">
                        <div><div class="text-sm opacity-70">ç¸½å…¬è²» (JPY)</div><div class="text-3xl font-bold mt-1">Â¥ {{ totalExpenses.toLocaleString() }}</div><div class="text-xs opacity-60 mt-1">ç´„ TWD {{ (totalExpenses * settings.rate).toFixed(0).toLocaleString() }}</div></div>
                        <button @click="toggleSettlement" class="bg-white/20 text-xs px-3 py-1 rounded backdrop-blur-sm hover:bg-white/30 transition"><i class="fas fa-calculator mr-1"></i>çµç®—å ±è¡¨</button>
                    </div>
                </div>
                <div v-if="showSettlement" class="bg-blue-50 rounded-2xl p-4 border border-blue-100 mb-6 animate-fade-in">
                    <h4 class="font-bold text-blue-800 mb-3"><i class="fas fa-file-invoice-dollar mr-2"></i>åˆ†å¸³å»ºè­°</h4>
                    <div v-if="settlementPlan.length === 0" class="text-sm text-gray-500 text-center py-2">ç›®å‰çµé¤˜å¹³è¡¡ï¼Œç„¡éœ€è½‰å¸³</div>
                    <div v-else class="space-y-2">
                        <div v-for="(plan, idx) in settlementPlan" :key="idx" class="flex justify-between items-center bg-white p-3 rounded-lg shadow-sm"><div class="flex items-center gap-2"><span class="font-bold text-gray-700">{{ plan.from }}</span><i class="fas fa-arrow-right text-gray-400 text-xs"></i><span class="font-bold text-gray-700">{{ plan.to }}</span></div><div class="text-blue-600 font-bold">Â¥{{ Math.round(plan.amount).toLocaleString() }}</div></div>
                        <p class="text-[10px] text-gray-400 text-center mt-2">*è¨ˆç®—åŒ¯ç‡: {{settings.rate}}</p>
                    </div>
                </div>
                <div class="flex items-center gap-2 mb-4 overflow-x-auto hide-scrollbar pb-1"><div v-for="(member, idx) in members" :key="idx" class="flex-shrink-0 bg-white border border-gray-200 px-3 py-1.5 rounded-full text-xs font-bold text-gray-600 shadow-sm flex items-center gap-2"><span @click="renameMember(idx)" class="cursor-pointer hover:text-blue-500">{{ member }} <i class="fas fa-pen ml-1 text-[8px] opacity-50"></i></span><button v-if="idx !== 0" @click="removeMember(idx)" class="text-gray-400 hover:text-red-500 rounded-full w-4 h-4 flex items-center justify-center bg-gray-50"><i class="fas fa-times text-[10px]"></i></button></div><button @click="addMember" class="flex-shrink-0 bg-gray-100 text-gray-400 px-3 py-1.5 rounded-full text-xs font-bold hover:bg-gray-200">+ äººå“¡</button></div>
                <div class="space-y-3">
                    <div v-for="(expense, idx) in expenses" :key="idx" class="bg-white rounded-xl p-3 shadow-sm border border-gray-100">
                        <div class="flex justify-between items-start">
                            <div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full flex items-center justify-center text-white text-sm" :class="getCategoryColor(expense.category)"><i :class="getCategoryIcon(expense.category)"></i></div><div><div class="font-bold text-gray-800">{{ expense.name }}</div><div class="text-[10px] text-gray-400 mt-0.5"><span class="bg-gray-100 px-1.5 py-0.5 rounded text-gray-500 mr-1">{{ expense.payer }} ä»˜æ¬¾</span><span v-if="expense.involved.length < members.length">({{ expense.involved.join(', ') }})</span><span v-else>(å…¨å“¡)</span></div></div></div>
                            <div class="text-right"><div class="font-bold text-gray-700">Â¥{{ expense.amount }}</div><div class="text-[10px] text-gray-400">{{ expense.date }}</div></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex gap-3 mt-6">
                <button v-if="isEditing" @click="confirmDelete" class="flex-1 bg-red-100 text-red-500 py-2 rounded-lg font-bold">åˆªé™¤</button>
                <button @click="showModal = false" class="flex-1 bg-gray-100 text-gray-500 py-2 rounded-lg font-bold">å–æ¶ˆ</button>
                <button @click="saveData" class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-bold">å„²å­˜</button>
            </div>
        </div>

    </div>
</div>

<script>
    const { createApp, ref, computed, onMounted, watch, onUnmounted } = Vue;
    // é‡è¦ï¼šç‰ˆæœ¬æ›´æ–°ï¼Œå¼·åˆ¶è¦†è“‹èˆŠè³‡æ–™
    const DATA_VERSION = 'v7.0_ITINERARY_UPDATE';

    createApp({
        setup() {
            const currentTab = ref('schedule');
            const currentDayIndex = ref(0);
            const showModal = ref(false);
            const modalType = ref('');
            const isEditing = ref(false);
            const isDraggable = ref(false); 
            const converter = ref({ jpy: 1000, twd: 225 }); 
            const weather = ref(null);
            const bannerRef = ref(null);
            
            const settings = ref({ rate: 0.225, lastUpdate: '' });
            const members = ref(['æˆ‘']);
            const showSettlement = ref(false);
            const currentChecklistMember = ref('æˆ‘');

            // ä½å®¿è³‡æ–™
            const hotels = ref([
                { name: 'Hotel Sunroute Asakusa', dates: '12/24 - 12/27', address: 'æ±äº¬éƒ½å°æ±å€é›·é–€1-8-5', phone: '+81-3-3847-1511', mapLink: 'https://www.google.com/maps/search/?api=1&query=Hotel+Sunroute+Asakusa' },
                { name: 'Hotel Nets Sapporo', dates: '12/27 - 12/31', address: 'åŒ—æµ·é“æœ­å¹Œå¸‚ä¸­å¤®å€å—7æ¡è¥¿4ä¸ç›®1-1', phone: '+81-11-530-5511', mapLink: 'https://www.google.com/maps/search/?api=1&query=Hotel+Nets+Sapporo' },
                { name: 'LA JOLIE MOTOMACHI', dates: '12/31 - 01/02', address: 'åŒ—æµ·é“å‡½é¤¨å¸‚æœ«å»£ç”º6-6', phone: '+81-138-23-3322', mapLink: 'https://www.google.com/maps/search/?api=1&query=LA+JOLIE+MOTOMACHI+Hakodate' },
                { name: 'Sotetsu Fresa Inn Tokyo-Roppongi', dates: '01/02 - 01/04', address: 'æ±äº¬éƒ½æ¸¯å€å…­æœ¬æœ¨3-10-1', phone: '+81-3-5413-2031', mapLink: 'https://www.google.com/maps/search/?api=1&query=Sotetsu+Fresa+Inn+Tokyo+Roppongi' }
            ]);

            // ** 12å¤©å®Œæ•´è¡Œç¨‹ (åŠ å…¥æ‚¨æŒ‡å®šçš„æ–°å…§å®¹) **
            const scheduleData = ref([
                { 
                    date: "2025-12-24", location: "Tokyo", 
                    events: [
                        { id: 101, category: 'transport', name: 'å‰å¾€æ¾å±±æ©Ÿå ´ (T1)', startTime: '07:06', endTime: '', transportType: 'train', transportTime: '30åˆ†', notes: 'æ­ä¹˜æ™®æ‚ ç‘ª+æ·é‹' },
                        { id: 102, category: 'flight', name: 'å°åŒ—(TSA) âœˆï¸ æ±äº¬(HND)', startTime: '13:30', endTime: '17:30', depCode: 'TSA', arrCode: 'HND', duration: '3h', transportType: 'train', transportTime: '45åˆ†', notes: 'ANA NH852' },
                        { id: 103, category: 'hotel', name: 'æ·ºè‰ç‡¦è·¯éƒ½é£¯åº— Check-in', startTime: '19:30', endTime: '', notes: 'é›¢ç”°åŸç”ºç«™è¿‘' }
                    ]
                },
                { 
                    date: "2025-12-25", location: "Tokyo", 
                    events: [
                        { id: 201, category: 'spot', name: 'æ±äº¬è¿ªå£«å°¼æ¨‚åœ’ (é™¸åœ°)', startTime: '09:00', endTime: '21:00', transportType: 'train', transportTime: '40åˆ†', notes: 'æ­¡æ…¶è–èª•ï¼' }
                    ]
                },
                { 
                    date: "2025-12-26", location: "Tokyo", 
                    events: [
                        { id: 301, category: 'spot', name: 'ç¯‰åœ°å¸‚å ´', startTime: '09:00', endTime: '12:00', transportType: 'subway', transportTime: '20åˆ†', notes: 'åƒæµ·é®®ä¸¼' },
                        { id: 302, category: 'spot', name: 'éŠ€åº§é€›è¡—', startTime: '13:00', endTime: '16:00', transportType: 'walk', transportTime: '15åˆ†', notes: 'æ­¥è¡Œè€…å¤©åœ‹' },
                        { id: 303, category: 'spot', name: 'é˜¿ç¾æ©«ä¸', startTime: '17:00', endTime: '19:00', transportType: 'train', transportTime: '-', notes: 'è—¥å¦æ¡è³¼' }
                    ]
                },
                { 
                    date: "2025-12-27", location: "Tokyo/Sapporo", 
                    events: [
                        { id: 401, category: 'spot', name: 'æ·ºè‰å¯º / é›·é–€', startTime: '09:00', endTime: '11:00', transportType: 'walk', transportTime: '15åˆ†', notes: 'æœ€å¾Œå·¡ç¦®' },
                        { id: 402, category: 'flight', name: 'æ±äº¬(HND) âœˆï¸ æœ­å¹Œ(CTS)', startTime: '18:00', endTime: '19:35', depCode: 'HND', arrCode: 'CTS', duration: '1h 35m', transportType: 'train', transportTime: '50åˆ†', notes: 'ANA NH75' },
                        { id: 403, category: 'hotel', name: 'æœ­å¹Œ Nets é£¯åº— Check-in', startTime: '21:00', endTime: '', notes: 'è–„é‡ç«™é™„è¿‘' }
                    ]
                },
                { 
                    date: "2025-12-28", location: "Sapporo", 
                    events: [
                        { id: 501, category: 'food', name: 'äºŒæ¢å¸‚å ´', startTime: '08:00', endTime: '10:00', transportType: 'walk', transportTime: '15åˆ†', notes: 'æ—©é¤' },
                        { id: 502, category: 'spot', name: 'å¤§é€šå…¬åœ’ & é›»è¦–å¡”', startTime: '10:30', endTime: '12:30', transportType: 'walk', transportTime: '10åˆ†', notes: 'æœ­å¹Œé›ªç¥­æœƒå ´' },
                        { id: 503, category: 'shop', name: 'ç‹¸å°è·¯å•†åº—è¡—', startTime: '14:00', endTime: '18:00', transportType: 'walk', transportTime: '-', notes: 'ä¼´æ‰‹ç¦®æ¡è²·' }
                    ]
                },
                { 
                    date: "2025-12-29", location: "Sapporo", 
                    events: [
                        { id: 601, category: 'spot', name: 'æ—­å·å‹•ç‰©åœ’', startTime: '10:30', endTime: '15:30', transportType: 'bus', transportTime: '2h', notes: 'çœ‹ä¼éµæ•£æ­¥' },
                        { id: 602, category: 'spot', name: 'å››å­£å½©ä¹‹ä¸˜', startTime: '16:00', endTime: '17:00', transportType: 'bus', transportTime: '30åˆ†', notes: 'é›ªä¸Šæ´»å‹•' },
                        { id: 603, category: 'spot', name: 'ç²¾éˆéœ²å°', startTime: '18:00', endTime: '19:30', transportType: 'bus', transportTime: '1h', notes: 'å¯Œè‰¯é‡é»ç‡ˆ' }
                    ]
                },
                { 
                    date: "2025-12-30", location: "Sapporo", 
                    events: [
                        { id: 701, category: 'spot', name: 'åŒ—æµ·é“ç¥å®®', startTime: '09:00', endTime: '11:00', transportType: 'subway', transportTime: '20åˆ†', notes: 'åƒæ‹œ' },
                        { id: 702, category: 'spot', name: 'ç™½è‰²æˆ€äººå…¬åœ’', startTime: '11:30', endTime: '13:30', transportType: 'subway', transportTime: '30åˆ†', notes: 'è§€å…‰å·¥å» ' },
                        { id: 703, category: 'spot', name: 'å°æ¨½é‹æ²³ & å ºç”ºé€š', startTime: '14:30', endTime: '18:30', transportType: 'train', transportTime: '40åˆ†', notes: 'å…­èŠ±äº­ã€åŒ—è“æ¨“' },
                        { id: 704, category: 'food', name: 'å°æ¨½å£½å¸', startTime: '19:00', endTime: '', transportType: 'walk', transportTime: '-', notes: 'å£½å¸é€šæ™šé¤' }
                    ]
                },
                { 
                    date: "2025-12-31", location: "Hakodate", 
                    events: [
                        { id: 801, category: 'transport', name: 'æœ­å¹Œ ğŸš„ å‡½é¤¨ (JRç‰¹æ€¥)', startTime: '10:56', endTime: '14:41', transportType: 'tram', transportTime: '4h', notes: 'åŒ—æ–—è™Ÿ (ç´„4å°æ™‚)' },
                        { id: 802, category: 'hotel', name: 'LA JOLIE MOTOMACHI Check-in', startTime: '15:30', endTime: '', transportType: 'walk', transportTime: '15åˆ†', notes: 'åå­—è¡—ç«™' },
                        { id: 803, category: 'spot', name: 'å‡½é¤¨å±±å¤œæ™¯', startTime: '17:00', endTime: '19:00', transportType: 'tram', transportTime: '-', notes: 'ç™¾è¬å¤œæ™¯' }
                    ]
                },
                { 
                    date: "2026-01-01", location: "Hakodate", 
                    events: [
                        { id: 901, category: 'food', name: 'å‡½é¤¨æœå¸‚', startTime: '08:00', endTime: '10:00', transportType: 'walk', transportTime: '10åˆ†', notes: 'é‡£çƒè³Š' },
                        { id: 902, category: 'spot', name: 'é‡‘æ£®ç´…ç£šå€‰åº«', startTime: '10:30', endTime: '13:00', transportType: 'walk', transportTime: '15åˆ†', notes: 'é€›è¡—' },
                        { id: 903, category: 'spot', name: 'äº”ç¨œéƒ­å…¬åœ’', startTime: '14:00', endTime: '16:30', transportType: 'tram', transportTime: '-', notes: 'äº”è§’æ˜Ÿå ¡å£˜' }
                    ]
                },
                { 
                    date: "2026-01-02", location: "Tokyo", 
                    events: [
                        { id: 1001, category: 'flight', name: 'å‡½é¤¨(HKD) âœˆï¸ æ±äº¬(HND)', startTime: '11:45', endTime: '13:15', depCode: 'HKD', arrCode: 'HND', duration: '1h 30m', transportType: 'train', transportTime: '50åˆ†', notes: 'ANA NH554' },
                        { id: 1002, category: 'hotel', name: 'å…­æœ¬æœ¨ Sotetsu Fresa Inn Check-in', startTime: '15:00', endTime: '', transportType: 'subway', transportTime: '-', notes: 'å…­æœ¬æœ¨ç«™' },
                        { id: 1003, category: 'spot', name: 'æ±äº¬éµå¡”', startTime: '17:00', endTime: '19:00', transportType: 'walk', transportTime: '-', notes: 'æ‹ç…§æ‰“å¡' }
                    ]
                },
                { 
                    date: "2026-01-03", location: "Tokyo", 
                    events: [
                        { id: 1101, category: 'spot', name: 'Shibuya Sky', startTime: '10:00', endTime: '12:00', transportType: 'subway', transportTime: '20åˆ†', notes: 'éœ€é ç´„' },
                        { id: 1102, category: 'shop', name: 'åŸå®¿ / è¡¨åƒé“', startTime: '13:00', endTime: '18:00', transportType: 'walk', transportTime: '-', notes: 'é€›è¡—è³¼ç‰©' }
                    ]
                },
                { 
                    date: "2026-01-04", location: "Tokyo", 
                    events: [
                        { id: 1201, category: 'transport', name: 'å‰å¾€ç¾½ç”°æ©Ÿå ´ (T2)', startTime: '09:30', endTime: '10:30', transportType: 'train', transportTime: '-', notes: 'ææ—©åˆ°æ©Ÿå ´' },
                        { id: 1202, category: 'flight', name: 'æ±äº¬(HND) âœˆï¸ å°åŒ—(TSA)', startTime: '12:40', endTime: '15:50', depCode: 'HND', arrCode: 'TSA', duration: '4h 10m', transportType: 'walk', transportTime: '-', notes: 'ANA NH853' }
                    ]
                }
            ]);

            const defaultPackingTemplate = [
                { name: 'é‡è¦æ–‡ä»¶', items: [ {name:'è­·ç…§',tag:'éš¨èº«',important:true}, {name:'ç°½è­‰',tag:'éš¨èº«',important:true}, {name:'åœ‹éš›é§•ç…§'}, {name:'æ©Ÿç¥¨',tag:'éš¨èº«',important:true}, {name:'ä½å®¿æ†‘è­‰'}, {name:'äº¤é€šç¥¨åˆ¸'}, {name:'å¤–å¹£',tag:'éš¨èº«',important:true}, {name:'ä¿¡ç”¨å¡',tag:'éš¨èº«',important:true}, {name:'æ—…éŠæ‰‹å†Š'} ] },
                { name: '3C ç”¢å“', items: [ {name:'æ‰‹æ©Ÿ',tag:'éš¨èº«',important:true}, {name:'å……é›»ç·š'}, {name:'å……é›»å™¨'}, {name:'è¡Œå‹•é›»æº',tag:'éš¨èº«',important:true}, {name:'è¬ç”¨è½‰æ¥é ­'}, {name:'ç­†é›»',tag:'éš¨èº«'}, {name:'ç›¸æ©Ÿ'}, {name:'ç¶²å¡'}, {name:'è‡ªæ‹æ£’'} ] },
                { name: 'ç›¥æ´—ç”¨å“', items: [ {name:'å¸å¦æ£‰'}, {name:'æ´—é¢ä¹³',tag:'æ‰˜é‹'}, {name:'ç‰™è†'}, {name:'ç‰™åˆ·'}, {name:'æ¿•ç´™å·¾'}, {name:'é¢ç´™'}, {name:'é˜²æ›¬ç”¨å“',tag:'æ‰˜é‹'}, {name:'ä¿é¤Šå“',tag:'æ‰˜é‹'}, {name:'è­·é«®ç”¨å“'} ] },
                { name: 'å€‹äººè—¥å“', items: [ {name:'çœ¼è—¥æ°´'}, {name:'éæ•è—¥'}, {name:'æšˆè»Šè—¥'}, {name:'æ„Ÿå†’è—¥'}, {name:'è…¸èƒƒè—¥'}, {name:'èšŠèŸ²æ­¢ç™¢è—¥'} ] },
                { name: 'å€‹äººè¡£ç‰©', items: [ {name:'æ›æ´—è¡£ç‰©'}, {name:'å¤–å¥—'}, {name:'é´å­'}, {name:'å…§è¡£è¤²'}, {name:'è¥ªå­'}, {name:'å¸½å­'} ] },
                { name: 'å…¶ä»–ç”¨å“', items: [ {name:'è€³å¡'}, {name:'å£ç½©'}, {name:'é›¨å‚˜',tag:'æ‰˜é‹'}, {name:'æ‰‹å¥—'}, {name:'è¡›ç”Ÿæ£‰'}, {name:'åŒ–å¦å“'} ] }
            ];

            const getNewPackingList = () => JSON.parse(JSON.stringify(defaultPackingTemplate));
            const packingData = ref({ 'æˆ‘': getNewPackingList() });

            const currentChecklistData = computed(() => {
                const member = currentChecklistMember.value || 'æˆ‘';
                if (!packingData.value[member]) packingData.value[member] = getNewPackingList();
                return packingData.value[member];
            });

            const shoppingList = ref([]);
            const expenses = ref([]);
            const editForm = ref({});
            const shoppingForm = ref({});
            const expenseForm = ref({});
            let sortableInstance = null;

            let canvas, ctx, animationId;
            const flakes = [];
            const snowPileHeight = new Array(480).fill(0);
            const initCanvas = () => { canvas = document.getElementById('snow-canvas'); if (!canvas) return; const resize = () => { canvas.width = canvas.parentElement.offsetWidth; canvas.height = canvas.parentElement.offsetHeight; if (snowPileHeight.length !== canvas.width) { snowPileHeight.length = canvas.width; for(let i=0; i<canvas.width; i++) snowPileHeight[i] = 0; } }; window.addEventListener('resize', resize); resize(); for (let i = 0; i < 50; i++) { flakes.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, r: Math.random() * 2 + 1, d: Math.random() * 0.5 + 0.2 }); } animateSnow(); };
            const animateSnow = () => { if (!canvas) return; ctx = canvas.getContext('2d'); ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.fillStyle = "rgba(255, 255, 255, 0.95)"; ctx.beginPath(); ctx.moveTo(0, canvas.height); for (let i = 0; i < canvas.width; i++) { let h = snowPileHeight[i]; ctx.lineTo(i, canvas.height - h); } ctx.lineTo(canvas.width, canvas.height); ctx.fill(); ctx.fillStyle = "rgba(255, 255, 255, 0.8)"; ctx.beginPath(); for (let i = 0; i < flakes.length; i++) { const f = flakes[i]; ctx.moveTo(f.x, f.y); ctx.arc(f.x, f.y, f.r, 0, Math.PI * 2, true); } ctx.fill(); updateFlakes(); animationId = requestAnimationFrame(animateSnow); };
            const updateFlakes = () => { for (let i = 0; i < flakes.length; i++) { const f = flakes[i]; f.y += Math.pow(f.d, 2) * 0.5 + 0.3; f.x += Math.sin(f.y * 0.05) * 0.3; const floorIndex = Math.floor(f.x); if (floorIndex >= 0 && floorIndex < canvas.width) { const pileHeight = snowPileHeight[floorIndex]; if (f.y + f.r >= canvas.height - pileHeight) { if (pileHeight < 25) { for(let k = -2; k <= 2; k++) { if (floorIndex + k >= 0 && floorIndex + k < canvas.width) { snowPileHeight[floorIndex + k] += 0.4 * (3 - Math.abs(k)); } } } resetFlake(f); } } else if (f.y > canvas.height) { resetFlake(f); } } };
            const resetFlake = (f) => { f.y = -10; f.x = Math.random() * canvas.width; };

            const cityMap = { 'Tokyo': { lat: 35.6895, lon: 139.6917 }, 'Sapporo': { lat: 43.0618, lon: 141.3545 }, 'Hakodate': { lat: 41.7687, lon: 140.7288 } };
            const getWeatherDesc = (code) => { if(code===0) return 'æ™´å¤©'; if(code<=3) return 'å¤šé›²'; if(code<=67) return 'æœ‰é›¨'; if(code<=86) return 'é™é›ª'; return 'é™°å¤©'; };
            const fetchWeather = async () => {
                const locRaw = scheduleData.value[currentDayIndex.value].location;
                const locKey = locRaw.split('/')[0];
                const coords = cityMap[locKey] || cityMap['Tokyo'];
                try {
                    const url = `https://api.open-meteo.com/v1/forecast?latitude=${coords.lat}&longitude=${coords.lon}&current=temperature_2m,apparent_temperature,weather_code,is_day&daily=uv_index_max&timezone=auto&forecast_days=1`;
                    const res = await fetch(url);
                    const data = await res.json();
                    if(data.current) {
                        let icon='fas fa-cloud', iconClass='text-gray-500', code=data.current.weather_code;
                        if(code===0){icon='fas fa-sun';iconClass='text-yellow-500';}else if(code<=3){icon='fas fa-cloud-sun';iconClass='text-gray-400';}else if(code<=67){icon='fas fa-cloud-rain';iconClass='text-blue-500';}else if(code>=71){icon='fas fa-snowflake';iconClass='text-blue-200';}
                        weather.value = { temp: Math.round(data.current.temperature_2m), feelsLike: Math.round(data.current.apparent_temperature), desc: getWeatherDesc(code), icon, iconClass, uv: data.daily?data.daily.uv_index_max[0]:0 };
                    }
                } catch(e) { weather.value={temp:'-',feelsLike:'-',desc:'N/A',icon:'fas fa-minus',uv:0}; }
            };
            const getUVColor = (uv) => { if(uv<=2)return 'text-green-500'; if(uv<=5)return 'text-yellow-500'; if(uv<=7)return 'text-orange-500'; return 'text-red-500'; };

            const calculateTWD = () => { if(settings.value.rate > 0) converter.value.twd = (converter.value.jpy * settings.value.rate).toFixed(0); };
            const calculateJPY = () => { if(settings.value.rate > 0) converter.value.jpy = (converter.value.twd / settings.value.rate).toFixed(0); };
            const fetchExchangeRate = async () => {
                try { const res = await fetch('https://api.exchangerate-api.com/v4/latest/JPY'); const data = await res.json(); if(data&&data.rates&&data.rates.TWD){ settings.value.rate = data.rates.TWD; settings.value.lastUpdate = new Date(data.time_last_updated*1000).toLocaleDateString(); calculateTWD(); } } catch(e){} };

            const resetAllData = () => { if(confirm("ç¢ºå®šè¦é‡ç½®æ‰€æœ‰è³‡æ–™å—ï¼Ÿ")) { localStorage.removeItem('tripData'); location.reload(); } };
            const persistData = () => { localStorage.setItem('tripData', JSON.stringify({ version: DATA_VERSION, schedule: scheduleData.value, shoppingList: shoppingList.value, expenses: expenses.value, members: members.value, settings: settings.value, packingData: packingData.value })); };

            onMounted(() => {
                const savedData = localStorage.getItem('tripData');
                if (savedData) {
                    const parsed = JSON.parse(savedData);
                    // æª¢æŸ¥ç‰ˆæœ¬è™Ÿï¼Œè‹¥ä¸åŒå‰‡å¼·åˆ¶æ›´æ–°è¡Œç¨‹
                    if (parsed.version === DATA_VERSION) {
                        scheduleData.value = parsed.schedule;
                        shoppingList.value = parsed.shoppingList || [];
                        expenses.value = parsed.expenses || [];
                        members.value = parsed.members || ['æˆ‘'];
                        if(parsed.settings) settings.value = parsed.settings;
                        if(parsed.packingData) packingData.value = parsed.packingData;
                    } else {
                        // ç‰ˆæœ¬ä¸åŒï¼Œæ›´æ–°è¡Œç¨‹ä½†ä¿ç•™å…¶ä»–è³‡æ–™
                        console.log("Updating to version: " + DATA_VERSION);
                        shoppingList.value = parsed.shoppingList || [];
                        expenses.value = parsed.expenses || [];
                        members.value = parsed.members || ['æˆ‘'];
                        if(parsed.settings) settings.value = parsed.settings;
                        if(parsed.packingData) packingData.value = parsed.packingData;
                        persistData(); // ç«‹å³å­˜æª”
                    }
                } else {
                    persistData(); // ç¬¬ä¸€æ¬¡åŸ·è¡Œï¼Œç›´æ¥å­˜æª”
                }
                
                initSortable(); fetchWeather(); fetchExchangeRate(); setTimeout(initCanvas, 100);
            });

            onUnmounted(() => { cancelAnimationFrame(animationId); });
            
            // ç›£è½ä¸¦è‡ªå‹•å­˜æª”
            watch([scheduleData, shoppingList, expenses, members, settings, packingData], () => { persistData(); }, { deep: true });
            watch(isDraggable, (val) => { if(sortableInstance) sortableInstance.option("disabled", !val); });
            const toggleDraggable = () => isDraggable.value = !isDraggable.value;
            watch(currentDayIndex, () => { setTimeout(initSortable, 100); fetchWeather(); });

            const packingProgress = computed(() => { let t=0, c=0; const l=currentChecklistData.value; if(l) l.forEach(cat => cat.items.forEach(i => { t++; if(i.checked) c++; })); return t===0?0:Math.round((c/t)*100); });
            const settlementPlan = computed(() => { let b={}; members.value.forEach(m=>b[m]=0); expenses.value.forEach(ex=>{ const a=parseFloat(ex.amount); if(!a||!ex.involved||ex.involved.length===0)return; b[ex.payer]=(b[ex.payer]||0)+a; const s=a/ex.involved.length; ex.involved.forEach(p=>b[p]=(b[p]||0)-s); }); let d=[], c=[]; for(let p in b){ if(b[p]<-1)d.push({name:p,amount:b[p]}); else if(b[p]>1)c.push({name:p,amount:b[p]}); } d.sort((a,b)=>a.amount-b.amount); c.sort((a,b)=>b.amount-a.amount); let plan=[], i=0, j=0; while(i<d.length && j<c.length){ let db=d[i], cr=c[j], a=Math.min(Math.abs(db.amount), cr.amount); plan.push({from:db.name, to:cr.name, amount:a}); db.amount+=a; cr.amount-=a; if(Math.abs(db.amount)<1)i++; if(cr.amount<1)j++; } return plan; });
            const totalExpenses = computed(() => expenses.value.reduce((sum, item) => sum + Number(item.amount), 0));
            const modalTitle = computed(() => ({ schedule: isEditing.value?'ç·¨è¼¯è¡Œç¨‹':'æ–°å¢è¡Œç¨‹', shopping:'æ–°å¢è³¼ç‰©æ¸…å–®', expense:'æ–°å¢èŠ±è²»' }[modalType.value] || ''));

            const handleAddClick = () => { if(currentTab.value==='schedule')openAddModal('schedule'); else if(currentTab.value==='shopping')openAddModal('shopping'); else if(currentTab.value==='expenses')openAddModal('expense'); };
            const openAddModal = (t) => { modalType.value=t; isEditing.value=false; editForm.value={category:'spot',transportType:'train',transportTime:'20åˆ†'}; shoppingForm.value={}; expenseForm.value={category:'food',payment:'ç¾é‡‘',date:scheduleData.value[currentDayIndex.value].date,payer:'æˆ‘',involved:[...members.value]}; showModal.value=true; };
            const editEvent = (i) => { if(isDraggable.value)return; if(i.category==='flight')return; modalType.value='schedule'; isEditing.value=true; editForm.value=JSON.parse(JSON.stringify(i)); showModal.value=true; };
            const handleImageUpload = (e) => { const f=e.target.files[0]; if(f){ const r=new FileReader(); r.onload=(e)=>shoppingForm.value.image=e.target.result; r.readAsDataURL(f); } };
            const saveData = () => { 
                if(modalType.value==='schedule'){ 
                    if(isEditing.value){ const idx=scheduleData.value[currentDayIndex.value].events.findIndex(e=>e.id===editForm.value.id); if(idx!==-1)scheduleData.value[currentDayIndex.value].events[idx]=editForm.value; } 
                    else { editForm.value.id=Date.now(); scheduleData.value[currentDayIndex.value].events.push(editForm.value); } 
                } else if(modalType.value==='shopping') {
                    shoppingList.value.push(shoppingForm.value); 
                } else if(modalType.value==='expense') {
                    expenses.value.push(expenseForm.value); 
                }
                persistData();
                showModal.value=false; 
            };
            const confirmDelete = () => { 
                if(confirm("åˆªé™¤?")){ 
                    const idx=scheduleData.value[currentDayIndex.value].events.findIndex(e=>e.id===editForm.value.id); 
                    if(idx!==-1)scheduleData.value[currentDayIndex.value].events.splice(idx,1); 
                    persistData();
                    showModal.value=false; 
                } 
            };
            const deleteShoppingItem = (i) => { 
                if(confirm("åˆªé™¤?")) {
                    shoppingList.value.splice(i,1); 
                    persistData();
                }
            };
            
            const toggleSettlement = () => showSettlement.value = !showSettlement.value;
            const addMember = () => { const n = prompt("è¼¸å…¥æ–°æˆå“¡åå­—:"); if(n && !members.value.includes(n)) { members.value.push(n); packingData.value[n] = getNewPackingList(); persistData(); } };
            const renameMember = (i) => { const old=members.value[i], n=prompt("ä¿®æ”¹åå­—:",old); if(n&&n!==old&&!members.value.includes(n)){ members.value[i]=n; if(packingData.value[old]) { packingData.value[n] = packingData.value[old]; delete packingData.value[old]; } else { packingData.value[n] = getNewPackingList(); } expenses.value.forEach(e=>{ if(e.payer===old)e.payer=n; if(e.involved.includes(old))e.involved[e.involved.indexOf(old)]=n; }); if (currentChecklistMember.value === old) currentChecklistMember.value = n; persistData(); } };
            const removeMember = (i) => { if(members.value[i]==='æˆ‘')return; if(confirm("åˆªé™¤æˆå“¡?")){ const nameToRemove = members.value[i]; members.value.splice(i,1); delete packingData.value[nameToRemove]; if (currentChecklistMember.value === nameToRemove) currentChecklistMember.value = 'æˆ‘'; persistData(); } };
            const toggleAllInvolved = () => { if(expenseForm.value.involved.length===members.value.length) expenseForm.value.involved=[]; else expenseForm.value.involved=[...members.value]; };
            
            const initSortable = () => { const el=document.getElementById('itinerary-list'); if(el){ sortableInstance=new Sortable(el,{ animation:150, handle:'.itinerary-item', disabled:!isDraggable.value, onEnd:(evt)=>{ const item=scheduleData.value[currentDayIndex.value].events.splice(evt.oldIndex,1)[0]; scheduleData.value[currentDayIndex.value].events.splice(evt.newIndex,0,item); persistData(); } }); } };
            
            const getDayName = (d) => new Date(d).toLocaleDateString('en-US', { weekday: 'short' });
            const getDayNum = (d) => new Date(d).getDate();
            const getCategoryIcon = (c) => ({ flight:'fa-plane', hotel:'fa-bed', spot:'fa-camera', food:'fa-utensils', shop:'fa-bag-shopping', transport:'fa-train', ticket:'fa-ticket', other:'fa-star' }[c] || 'fa-circle');
            const getCategoryColor = (c) => ({ flight:'bg-blue-400', hotel:'bg-indigo-400', spot:'bg-pink-400', food:'bg-orange-400', shop:'bg-yellow-400', transport:'bg-green-400' }[c] || 'bg-gray-400');
            const getTransportIcon = (t) => { const map={walk:'fa-person-walking', subway:'fa-train-subway', train:'fa-train', hsr:'fa-train', tram:'fa-train-tram', taxi:'fa-taxi', bus:'fa-bus'}; return `fas ${map[t]||'fa-person-walking'}`; };
            const getWeatherIcon = (code) => { if(code<=3)return 'fas fa-sun'; if(code<=60)return 'fas fa-cloud-rain'; if(code<=80)return 'fas fa-snowflake'; return 'fas fa-cloud'; };
            const getMapLink = (n) => `https://www.google.com/maps/search/?api=1&query=$${encodeURIComponent(n)}`;
            const getUVColor = (uv) => { if(uv <= 2) return 'text-green-500'; if(uv <= 5) return 'text-yellow-500'; if(uv <= 7) return 'text-orange-500'; return 'text-red-500'; };

            return {
                currentTab, currentDayIndex, schedule: scheduleData, showModal, modalType, isEditing, modalTitle,
                editForm, shoppingForm, expenseForm, shoppingList, expenses, converter, weather, settings, members, hotels, packingList: currentChecklistData,
                totalExpenses, bannerRef, showSettlement, settlementPlan, toggleSettlement, addMember, removeMember, renameMember, toggleAllInvolved, packingProgress,
                openAddModal, editEvent, saveData, confirmDelete, deleteShoppingItem, handleImageUpload,
                getDayName, getDayNum, getCategoryIcon, getCategoryColor, getTransportIcon, getWeatherIcon, getMapLink, getUVColor,
                isDraggable, toggleDraggable, handleAddClick, calculateTWD, calculateJPY, resetAllData, toggleCheckItem: (item) => { item.checked = !item.checked; persistData(); },
                currentChecklistMember, currentChecklistData, exportDataForCode
            };
        }
    }).mount('#app');
</script>

</body>
</html>
